# A2A 协议集成指南（Agent-to-Agent）

> **版本**: v1.0.0
> **创建日期**: 2026-02-02
> **文档状态**: 技术指南
> **Spring AI Alibaba版本**: 1.1.0.0-RC2

---

## 一、A2A 协议概述

### 1.1 什么是 A2A

```
A2A (Agent-to-Agent) 是 Spring AI Alibaba 提供的 Agent 间通信协议，
用于实现跨服务的 Agent 协作、任务委派和能力共享。

┌─────────────────────────────────────────────────────────────┐
│                    A2A 协议架构图                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌────────────────┐                    ┌────────────────┐  │
│  │  hr-ai-service │                    │hr-recruit-service│ │
│  │                │                    │                │  │
│  │ ┌────────────┐ │  A2A TaskRequest  │ ┌────────────┐ │  │
│  │ │ HR Policy  │─┼───────────────────┼→│ Recruiting │ │  │
│  │ │   Agent    │ │                    │ │   Agent    │ │  │
│  │ └────────────┘ │  A2A TaskResponse  │ └────────────┘ │  │
│  │                │←───────────────────┼─                │  │
│  └────────────────┘                    └────────────────┘  │
│          ▲                                      ▲          │
│          │                                      │          │
│          └──────────┬───────────────────────────┘          │
│                     ▼                                      │
│          ┌─────────────────────┐                           │
│          │ Nacos A2A Registry  │  (Agent 能力发现)         │
│          │                     │                           │
│          │  - Agent Metadata   │                           │
│          │  - Capability List  │                           │
│          │  - Task Handlers    │                           │
│          └─────────────────────┘                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心能力

| 能力 | 描述 | 场景示例 |
|------|------|---------|
| **任务委派** | Agent A 将任务委派给 Agent B | HR Agent 委派简历解析给 Recruiting Agent |
| **能力发现** | 通过 Nacos 动态发现其他 Agent | 查询哪些 Agent 支持"薪资计算"能力 |
| **消息传递** | Agent 间双向消息通信 | Agent A 向 Agent B 发送中间结果 |
| **状态同步** | 任务执行状态实时同步 | 查询委派任务的执行进度 |

---

## 二、依赖配置

### 2.1 Maven依赖

```xml
<!-- pom.xml -->
<dependencies>
    <!-- A2A 服务端（提供 Agent 能力） -->
    <dependency>
        <groupId>com.alibaba.cloud.ai</groupId>
        <artifactId>spring-ai-alibaba-starter-a2a-server</artifactId>
        <version>1.1.0.0-RC2</version>
    </dependency>

    <!-- A2A Nacos 发现（Agent 注册与发现） -->
    <dependency>
        <groupId>com.alibaba.cloud.ai</groupId>
        <artifactId>spring-ai-alibaba-starter-a2a-nacos-discovery</artifactId>
        <version>1.1.0.0-RC2</version>
    </dependency>

    <!-- Spring AI Alibaba Agent Framework -->
    <dependency>
        <groupId>com.alibaba.cloud.ai</groupId>
        <artifactId>spring-ai-alibaba-starter-agent</artifactId>
        <version>1.1.0.0-RC2</version>
    </dependency>

    <!-- Nacos 服务发现 -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>

    <!-- Kafka（A2A 消息持久化） -->
    <dependency>
        <groupId>org.springframework.kafka</groupId>
        <artifactId>spring-kafka</artifactId>
    </dependency>
</dependencies>
```

### 2.2 配置文件

```yaml
# application.yml
spring:
  ai:
    alibaba:
      a2a:
        # A2A 服务端配置
        server:
          enabled: true
          port: ${server.port}  # 使用服务端口
          context-path: /a2a    # A2A 接口路径

        # Nacos 注册配置
        nacos:
          enabled: true
          server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
          namespace: ${NACOS_NAMESPACE:hr-ai-dev}
          group: HRAI_A2A_GROUP

          # Agent 元数据
          agent:
            name: ${spring.application.name}-agent
            description: ${agent.description:HR AI Agent}
            version: 1.0.0
            capabilities: ${agent.capabilities:}  # 能力列表

        # 消息持久化（Kafka）
        message:
          enabled: true
          topic: a2a-task-delegation
          consumer-group: ${spring.application.name}-a2a-group
```

---

## 三、Agent 定义与注册

### 3.1 定义 Agent

```java
package com.hrai.ai.agents;

import com.alibaba.cloud.ai.agent.Agent;
import com.alibaba.cloud.ai.agent.AgentContext;
import com.alibaba.cloud.ai.agent.AgentResponse;
import com.alibaba.cloud.ai.a2a.annotation.A2AAgent;
import com.alibaba.cloud.ai.a2a.annotation.A2ACapability;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * HR政策专家 Agent
 */
@Slf4j
@Component
@A2AAgent(
    name = "hr-policy-agent",
    description = "HR政策专家Agent，提供HR政策查询、解释和建议",
    capabilities = {
        @A2ACapability(name = "hr-policy-query", description = "查询HR政策"),
        @A2ACapability(name = "leave-policy-explain", description = "解释请假政策"),
        @A2ACapability(name = "salary-policy-query", description = "查询薪资政策")
    }
)
public class HRPolicyAgent implements Agent {

    @Override
    public AgentResponse execute(AgentContext context) {
        String userMessage = context.getUserMessage();
        log.info("HR Policy Agent 收到请求: {}", userMessage);

        // 业务处理逻辑
        String response = processHRPolicyQuery(userMessage);

        return AgentResponse.builder()
            .content(response)
            .success(true)
            .build();
    }

    private String processHRPolicyQuery(String query) {
        // 实际业务逻辑：调用 RAG 检索 HR 政策知识库
        return "根据公司政策，" + query + "的相关规定如下...";
    }
}
```

### 3.2 Agent 元数据配置

```yaml
# application.yml（hr-ai-service）
agent:
  description: HR政策专家Agent，提供HR政策查询和解释
  capabilities:
    - hr-policy-query
    - leave-policy-explain
    - salary-policy-query
```

### 3.3 自动注册到 Nacos

```java
@Configuration
@EnableA2A  // 启用 A2A 功能
public class A2AConfig {

    @Bean
    public A2AAgentRegistry agentRegistry() {
        return new NacosA2AAgentRegistry();
    }
}
```

启动服务后，Agent 会自动注册到 Nacos A2A Registry：

```bash
# 查询已注册的 Agent
curl http://localhost:8848/nacos/v1/ns/service/list?groupName=HRAI_A2A_GROUP

# 预期输出
{
  "services": [
    "hr-policy-agent",
    "recruiting-agent",
    "payroll-explainer-agent",
    ...
  ]
}
```

---

## 四、A2A 任务委派

### 4.1 任务委派 API

#### 4.1.1 定义任务请求

```java
package com.hrai.ai.a2a.dto;

import lombok.Builder;
import lombok.Data;

import java.util.Map;

/**
 * A2A 任务请求
 */
@Data
@Builder
public class A2ATaskRequest {
    private String taskId;              // 任务ID（唯一）
    private String fromAgent;           // 发起Agent
    private String toAgent;             // 目标Agent
    private String capability;          // 请求的能力
    private String message;             // 任务消息
    private Map<String, Object> params; // 任务参数
    private String tenantId;            // 租户ID
    private Long userId;                // 用户ID
    private Integer timeout;            // 超时时间（秒）
}
```

#### 4.1.2 定义任务响应

```java
package com.hrai.ai.a2a.dto;

import lombok.Builder;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.Map;

/**
 * A2A 任务响应
 */
@Data
@Builder
public class A2ATaskResponse {
    private String taskId;              // 任务ID
    private Boolean success;            // 是否成功
    private String message;             // 响应消息
    private Map<String, Object> result; // 响应结果
    private String errorCode;           // 错误码
    private LocalDateTime completedAt;  // 完成时间
}
```

### 4.2 委派任务（调用方）

```java
package com.hrai.ai.service;

import com.alibaba.cloud.ai.a2a.client.A2AClient;
import com.hrai.ai.a2a.dto.A2ATaskRequest;
import com.hrai.ai.a2a.dto.A2ATaskResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * A2A 任务委派服务
 */
@Slf4j
@Service
public class A2ATaskDelegationService {

    @Autowired
    private A2AClient a2aClient;

    /**
     * 委派简历解析任务给 Recruiting Agent
     */
    public A2ATaskResponse delegateResumeParsingTask(String resumeContent) {
        String taskId = UUID.randomUUID().toString();

        // 构建任务请求
        Map<String, Object> params = new HashMap<>();
        params.put("resumeContent", resumeContent);
        params.put("format", "pdf");

        A2ATaskRequest request = A2ATaskRequest.builder()
            .taskId(taskId)
            .fromAgent("hr-policy-agent")
            .toAgent("recruiting-agent")
            .capability("resume-parsing")
            .message("请解析候选人简历")
            .params(params)
            .tenantId(TenantContext.getTenantId())
            .userId(TenantContext.getUserId())
            .timeout(30)  // 30秒超时
            .build();

        log.info("委派A2A任务: taskId={}, toAgent={}, capability={}",
            taskId, request.getToAgent(), request.getCapability());

        // 发送任务（同步调用）
        A2ATaskResponse response = a2aClient.delegateTask(request);

        if (response.getSuccess()) {
            log.info("A2A任务执行成功: taskId={}, result={}",
                taskId, response.getResult());
        } else {
            log.error("A2A任务执行失败: taskId={}, errorCode={}, message={}",
                taskId, response.getErrorCode(), response.getMessage());
        }

        return response;
    }

    /**
     * 异步委派任务
     */
    public String delegateTaskAsync(A2ATaskRequest request) {
        String taskId = request.getTaskId();

        // 发送到 Kafka
        a2aClient.delegateTaskAsync(request, (response) -> {
            // 回调处理
            if (response.getSuccess()) {
                log.info("异步任务完成: taskId={}", taskId);
                handleTaskCompleted(response);
            } else {
                log.error("异步任务失败: taskId={}", taskId);
                handleTaskFailed(response);
            }
        });

        log.info("异步任务已提交: taskId={}", taskId);
        return taskId;
    }

    private void handleTaskCompleted(A2ATaskResponse response) {
        // 处理任务完成逻辑
    }

    private void handleTaskFailed(A2ATaskResponse response) {
        // 处理任务失败逻辑
    }
}
```

### 4.3 接收任务（被调用方）

```java
package com.hrai.recruit.a2a;

import com.alibaba.cloud.ai.a2a.annotation.A2ATaskHandler;
import com.alibaba.cloud.ai.a2a.model.A2ATask;
import com.hrai.ai.a2a.dto.A2ATaskRequest;
import com.hrai.ai.a2a.dto.A2ATaskResponse;
import com.hrai.recruit.service.ResumeParserService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.Map;

/**
 * Recruiting Agent A2A 任务处理器
 */
@Slf4j
@Component
public class RecruitingAgentA2AHandler {

    @Autowired
    private ResumeParserService resumeParserService;

    /**
     * 处理简历解析任务
     */
    @A2ATaskHandler(capability = "resume-parsing")
    public A2ATaskResponse handleResumeParsingTask(A2ATaskRequest request) {
        log.info("收到A2A任务: taskId={}, capability={}, fromAgent={}",
            request.getTaskId(), request.getCapability(), request.getFromAgent());

        try {
            // 设置租户上下文
            TenantContext.setTenantId(request.getTenantId());
            TenantContext.setUserId(request.getUserId());

            // 提取参数
            String resumeContent = (String) request.getParams().get("resumeContent");

            // 执行简历解析
            Map<String, Object> parseResult = resumeParserService.parseResume(resumeContent);

            // 返回成功响应
            return A2ATaskResponse.builder()
                .taskId(request.getTaskId())
                .success(true)
                .message("简历解析完成")
                .result(parseResult)
                .completedAt(LocalDateTime.now())
                .build();

        } catch (Exception e) {
            log.error("A2A任务执行失败: taskId={}", request.getTaskId(), e);

            return A2ATaskResponse.builder()
                .taskId(request.getTaskId())
                .success(false)
                .message("简历解析失败: " + e.getMessage())
                .errorCode("RESUME_PARSE_ERROR")
                .completedAt(LocalDateTime.now())
                .build();

        } finally {
            TenantContext.clear();
        }
    }

    /**
     * 处理候选人匹配任务
     */
    @A2ATaskHandler(capability = "candidate-matching")
    public A2ATaskResponse handleCandidateMatchingTask(A2ATaskRequest request) {
        log.info("收到候选人匹配任务: taskId={}", request.getTaskId());

        // 业务处理逻辑
        // ...

        return A2ATaskResponse.builder()
            .taskId(request.getTaskId())
            .success(true)
            .message("候选人匹配完成")
            .build();
    }
}
```

---

## 五、Agent 能力发现

### 5.1 查询可用 Agent

```java
@Service
@Slf4j
public class A2ADiscoveryService {

    @Autowired
    private A2AAgentRegistry agentRegistry;

    /**
     * 查询所有可用 Agent
     */
    public List<AgentInfo> listAllAgents() {
        return agentRegistry.listAllAgents();
    }

    /**
     * 根据能力查找 Agent
     */
    public List<AgentInfo> findAgentsByCapability(String capability) {
        log.info("查找支持能力的Agent: capability={}", capability);

        return agentRegistry.listAllAgents().stream()
            .filter(agent -> agent.getCapabilities().contains(capability))
            .collect(Collectors.toList());
    }

    /**
     * 检查 Agent 是否在线
     */
    public boolean isAgentOnline(String agentName) {
        return agentRegistry.getAgent(agentName) != null;
    }
}
```

### 5.2 动态路由到合适的 Agent

```java
@Service
@Slf4j
public class A2ARouterService {

    @Autowired
    private A2ADiscoveryService discoveryService;

    @Autowired
    private A2ATaskDelegationService delegationService;

    /**
     * 根据能力动态路由任务
     */
    public A2ATaskResponse routeTaskByCapability(String capability, String message, Map<String, Object> params) {
        // 1. 查找支持该能力的 Agent
        List<AgentInfo> agents = discoveryService.findAgentsByCapability(capability);

        if (agents.isEmpty()) {
            throw new BizException("没有Agent支持该能力: " + capability);
        }

        // 2. 负载均衡选择 Agent（简单轮询）
        AgentInfo selectedAgent = agents.get(0);

        // 3. 构建任务请求
        A2ATaskRequest request = A2ATaskRequest.builder()
            .taskId(UUID.randomUUID().toString())
            .fromAgent("hr-policy-agent")
            .toAgent(selectedAgent.getName())
            .capability(capability)
            .message(message)
            .params(params)
            .build();

        // 4. 委派任务
        return delegationService.delegateTask(request);
    }
}
```

---

## 六、A2A 消息持久化（Kafka）

### 6.1 Kafka Topic 配置

```yaml
# application.yml
spring:
  kafka:
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

    consumer:
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      group-id: ${spring.application.name}-a2a-group
      properties:
        spring.json.trusted.packages: com.hrai.*
```

### 6.2 A2A 消息发送

```java
@Component
@Slf4j
public class A2AMessageProducer {

    @Autowired
    private KafkaTemplate<String, A2ATaskRequest> kafkaTemplate;

    private static final String A2A_TASK_TOPIC = "a2a-task-delegation";

    /**
     * 发送 A2A 任务到 Kafka
     */
    public void sendTaskMessage(A2ATaskRequest request) {
        String key = request.getTaskId();

        kafkaTemplate.send(A2A_TASK_TOPIC, key, request)
            .addCallback(
                result -> log.info("A2A任务消息已发送: taskId={}, offset={}",
                    key, result.getRecordMetadata().offset()),
                ex -> log.error("A2A任务消息发送失败: taskId={}", key, ex)
            );
    }
}
```

### 6.3 A2A 消息消费

```java
@Component
@Slf4j
public class A2AMessageConsumer {

    @Autowired
    private RecruitingAgentA2AHandler taskHandler;

    @KafkaListener(
        topics = "a2a-task-delegation",
        groupId = "recruiting-service-a2a-group"
    )
    public void consumeTaskMessage(
            @Payload A2ATaskRequest request,
            Acknowledgment ack) {

        log.info("收到A2A任务消息: taskId={}, capability={}",
            request.getTaskId(), request.getCapability());

        try {
            // 路由到对应的任务处理器
            A2ATaskResponse response = taskHandler.handleResumeParsingTask(request);

            // 发送响应到 Kafka（如果是异步模式）
            if (response.getSuccess()) {
                sendTaskResponse(response);
            }

            ack.acknowledge();

        } catch (Exception e) {
            log.error("A2A任务处理失败: taskId={}", request.getTaskId(), e);
            // 不确认消息，会重新消费
        }
    }

    private void sendTaskResponse(A2ATaskResponse response) {
        // 发送响应到 a2a-task-response Topic
    }
}
```

---

## 七、实际应用场景

### 7.1 场景1：简历智能解析

```
用户请求 → HR AI Agent（hr-ai-service）
           ↓
       A2A委派简历解析任务
           ↓
Recruiting Agent（hr-recruit-service）
           ↓
       执行简历解析（AI模型）
           ↓
       返回解析结果
           ↓
HR AI Agent 合成响应返回用户
```

**代码示例**：

```java
@Service
public class ResumeAnalysisService {

    @Autowired
    private A2ATaskDelegationService a2aDelegation;

    public String analyzeResume(String resumeContent) {
        // 委派给 Recruiting Agent
        A2ATaskResponse response = a2aDelegation.delegateResumeParsingTask(resumeContent);

        if (response.getSuccess()) {
            Map<String, Object> result = response.getResult();
            return formatResumeAnalysis(result);
        } else {
            return "简历解析失败，请稍后重试";
        }
    }

    private String formatResumeAnalysis(Map<String, Object> result) {
        return "姓名: " + result.get("name") +
               "\n学历: " + result.get("education") +
               "\n工作经验: " + result.get("experience") + "年";
    }
}
```

### 7.2 场景2：薪资政策解释

```
用户提问薪资政策 → HR AI Agent
                   ↓
               检查自己的知识库
                   ↓
           如果需要详细计算公式
                   ↓
           A2A委派给 Payroll Agent
                   ↓
     Payroll Agent 返回薪资计算详情
                   ↓
     HR AI Agent 综合生成回答
```

### 7.3 场景3：多 Agent 协作工作流

```
用户: "帮我招聘一个Java工程师"

HR AI Agent:
  1. 委派给 Recruiting Agent：创建招聘需求
  2. 委派给 Recruiting Agent：筛选候选人
  3. 委派给 Performance Agent：获取面试评估模板
  4. 综合结果返回用户
```

---

## 八、监控与调试

### 8.1 A2A 任务监控

```java
@RestController
@RequestMapping("/api/a2a/monitor")
public class A2AMonitorController {

    @Autowired
    private A2ATaskRepository taskRepository;

    /**
     * 查询任务执行状态
     */
    @GetMapping("/tasks/{taskId}")
    public Result<A2ATaskStatus> getTaskStatus(@PathVariable String taskId) {
        A2ATaskStatus status = taskRepository.findByTaskId(taskId);
        return Result.success(status);
    }

    /**
     * 统计 Agent 调用次数
     */
    @GetMapping("/stats/agent/{agentName}")
    public Result<AgentStats> getAgentStats(@PathVariable String agentName) {
        AgentStats stats = taskRepository.getAgentStats(agentName);
        return Result.success(stats);
    }
}
```

### 8.2 Prometheus 指标

```java
@Configuration
public class A2AMetricsConfig {

    @Bean
    public MeterBinder a2aMetrics(A2ATaskRepository taskRepository) {
        return (registry) -> {
            Gauge.builder("a2a.tasks.pending", taskRepository, A2ATaskRepository::countPending)
                .description("A2A 待处理任务数")
                .register(registry);

            Gauge.builder("a2a.tasks.processing", taskRepository, A2ATaskRepository::countProcessing)
                .description("A2A 处理中任务数")
                .register(registry);
        };
    }
}
```

---

## 九、最佳实践

### 9.1 任务超时处理

```java
@A2ATaskHandler(capability = "resume-parsing", timeout = 30)
public A2ATaskResponse handleResumeParsingTask(A2ATaskRequest request) {
    // 30秒后自动超时
}
```

### 9.2 幂等性保证

```java
@A2ATaskHandler(capability = "resume-parsing")
public A2ATaskResponse handleResumeParsingTask(A2ATaskRequest request) {
    String taskId = request.getTaskId();

    // 检查任务是否已处理
    if (isTaskProcessed(taskId)) {
        log.warn("任务重复处理，已跳过: taskId={}", taskId);
        return getCachedResponse(taskId);
    }

    // 处理任务
    A2ATaskResponse response = processTask(request);

    // 缓存响应
    cacheResponse(taskId, response);

    return response;
}
```

### 9.3 错误重试策略

```yaml
spring:
  ai:
    alibaba:
      a2a:
        retry:
          max-attempts: 3
          backoff:
            initial-interval: 1000
            multiplier: 2.0
            max-interval: 10000
```

---

## 十、常见问题

### 10.1 Agent 未注册到 Nacos

```
问题：启动服务后，Nacos 看不到 Agent

排查：
1. 检查 @A2AAgent 注解是否正确
2. 检查 Nacos 服务是否运行
3. 检查 application.yml 中 a2a.nacos 配置
4. 查看启动日志中的 A2A 注册信息
```

### 10.2 任务委派失败

```
问题：a2aClient.delegateTask() 抛出异常

排查：
1. 确认目标 Agent 是否在线
2. 确认 capability 名称是否正确
3. 检查网络连通性
4. 查看 Kafka 消息是否发送成功
```

### 10.3 任务超时

```
问题：任务执行时间过长导致超时

解决：
1. 增加 timeout 配置
2. 改为异步委派（delegateTaskAsync）
3. 优化任务处理逻辑
4. 拆分大任务为多个小任务
```

---

> **重要**: A2A 协议是微服务 Agent 协作的核心机制，合理使用可大幅提升系统智能化水平。建议先从简单场景入手，逐步扩展到复杂的多 Agent 协作工作流。
