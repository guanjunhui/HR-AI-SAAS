# 后端包结构设计

> Spring Boot 多模块项目结构

## 模块结构

```
hr-ai-saas/
├── pom.xml                           # 父POM
├── hr-ai-common/                     # 公共模块
│   ├── pom.xml
│   └── src/main/java/com/hrai/common/
│
└── hr-ai-agent-core/                 # 核心服务模块
    ├── pom.xml
    └── src/main/java/com/hrai/agent/
```

---

## hr-ai-common 模块

公共组件，被其他模块依赖。

```
com.hrai.common/
├── constant/                         # 常量定义
│   ├── TenantConstants.java          # 租户相关常量
│   ├── StatusConstants.java          # 状态常量
│   └── ErrorCodeConstants.java       # 错误码常量
│
├── context/                          # 上下文
│   └── TenantContext.java            # 租户上下文(ThreadLocal)
│
├── dto/                              # 通用DTO
│   ├── Result.java                   # 统一响应
│   ├── PageRequest.java              # 分页请求
│   └── PageResult.java               # 分页结果
│
├── exception/                        # 异常定义
│   ├── BizException.java             # 业务异常
│   ├── AuthException.java            # 认证异常
│   └── GlobalExceptionHandler.java   # 全局异常处理
│
├── util/                             # 工具类
│   ├── JsonUtils.java                # JSON工具
│   ├── DateUtils.java                # 日期工具
│   ├── IdGenerator.java              # ID生成器
│   └── SecurityUtils.java            # 安全工具
│
└── annotation/                       # 自定义注解
    ├── RequirePermission.java        # 权限注解
    └── AuditLog.java                 # 审计日志注解
```

---

## hr-ai-agent-core 模块

核心业务服务模块，完整包结构如下：

```
com.hrai.agent/
│
├── AgentApplication.java             # 启动类
│
├── config/                           # 配置类
│   ├── MilvusConfig.java             # Milvus向量库配置
│   ├── KafkaConfig.java              # Kafka配置
│   ├── McpServerConfig.java          # MCP配置
│   ├── WebMvcConfig.java             # Web配置
│   ├── RedisConfig.java              # Redis配置
│   ├── SecurityConfig.java           # 安全配置
│   ├── SwaggerConfig.java            # API文档配置
│   └── StateMachineConfig.java       # 状态机配置
│
├── interceptor/                      # 拦截器
│   ├── TenantInterceptor.java        # 租户拦截器
│   └── AuthInterceptor.java          # 认证拦截器
│
├── controller/                       # 基础Controller
│   └── HealthController.java         # 健康检查
│
├── a2a/                              # A2A协议
│   └── AgentTaskDelegation.java      # Agent任务委派
│
│
│  ============= 业务模块 =============
│
├── org/                              # M01 组织与权限
│   ├── controller/
│   │   ├── OrgUnitController.java
│   │   ├── UserController.java
│   │   ├── RoleController.java
│   │   └── AuditLogController.java
│   ├── service/
│   │   ├── OrgUnitService.java
│   │   ├── impl/
│   │   │   └── OrgUnitServiceImpl.java
│   │   ├── UserService.java
│   │   ├── impl/
│   │   │   └── UserServiceImpl.java
│   │   ├── RoleService.java
│   │   ├── impl/
│   │   │   └── RoleServiceImpl.java
│   │   ├── PermissionService.java
│   │   └── AuditLogService.java
│   ├── mapper/
│   │   ├── OrgUnitMapper.java
│   │   ├── SysUserMapper.java
│   │   ├── SysRoleMapper.java
│   │   ├── SysUserRoleMapper.java
│   │   ├── SysRolePermissionMapper.java
│   │   └── AuditLogMapper.java
│   ├── entity/
│   │   ├── OrgUnit.java
│   │   ├── SysUser.java
│   │   ├── SysRole.java
│   │   ├── SysUserRole.java
│   │   ├── SysRolePermission.java
│   │   └── AuditLog.java
│   └── dto/
│       ├── OrgUnitDTO.java
│       ├── OrgTreeDTO.java
│       ├── UserDTO.java
│       ├── UserCreateDTO.java
│       ├── RoleDTO.java
│       └── AuditLogQueryDTO.java
│
├── hr/                               # M02 Core HR
│   ├── controller/
│   │   ├── PositionController.java
│   │   ├── HeadcountController.java
│   │   ├── EmployeeController.java
│   │   └── EmploymentEventController.java
│   ├── service/
│   │   ├── PositionService.java
│   │   ├── HeadcountService.java
│   │   ├── EmployeeService.java
│   │   └── EmploymentEventService.java
│   ├── statemachine/
│   │   ├── EmploymentEventStateMachine.java
│   │   ├── EmploymentEventState.java
│   │   └── EmploymentEventEvent.java
│   ├── mapper/
│   │   ├── PositionMapper.java
│   │   ├── HeadcountMapper.java
│   │   ├── EmployeeMapper.java
│   │   ├── EmployeeDetailMapper.java
│   │   └── EmploymentEventMapper.java
│   ├── entity/
│   │   ├── Position.java
│   │   ├── Headcount.java
│   │   ├── Employee.java
│   │   ├── EmployeeDetail.java
│   │   └── EmploymentEvent.java
│   └── dto/
│       ├── PositionDTO.java
│       ├── HeadcountDTO.java
│       ├── EmployeeDTO.java
│       ├── EmployeeCreateDTO.java
│       ├── EmployeeDetailDTO.java
│       └── EmploymentEventDTO.java
│
├── recruiting/                       # M03 招聘管理
│   ├── controller/
│   │   ├── JobRequisitionController.java
│   │   ├── CandidateController.java
│   │   ├── InterviewController.java
│   │   └── OfferController.java
│   ├── service/
│   │   ├── JobRequisitionService.java
│   │   ├── CandidateService.java
│   │   ├── CandidateResumeService.java
│   │   ├── CandidateApplicationService.java
│   │   ├── InterviewService.java
│   │   ├── InterviewFeedbackService.java
│   │   └── OfferService.java
│   ├── statemachine/
│   │   ├── JobRequisitionStateMachine.java
│   │   ├── JobRequisitionState.java
│   │   ├── JobRequisitionEvent.java
│   │   ├── CandidateStateMachine.java
│   │   ├── CandidateState.java
│   │   └── CandidateEvent.java
│   ├── ai/
│   │   ├── ResumeParserAgent.java
│   │   └── CandidateMatchAgent.java
│   ├── integration/
│   │   └── OnboardingIntegration.java
│   ├── mapper/
│   │   ├── JobRequisitionMapper.java
│   │   ├── CandidateMapper.java
│   │   ├── CandidateResumeMapper.java
│   │   ├── CandidateApplicationMapper.java
│   │   ├── InterviewMapper.java
│   │   ├── InterviewFeedbackMapper.java
│   │   └── OfferMapper.java
│   ├── entity/
│   │   ├── JobRequisition.java
│   │   ├── Candidate.java
│   │   ├── CandidateResume.java
│   │   ├── CandidateApplication.java
│   │   ├── Interview.java
│   │   ├── InterviewFeedback.java
│   │   └── Offer.java
│   └── dto/
│       ├── JobRequisitionDTO.java
│       ├── CandidateDTO.java
│       ├── ResumeDTO.java
│       ├── InterviewDTO.java
│       ├── InterviewFeedbackDTO.java
│       └── OfferDTO.java
│
├── onboarding/                       # M04 入职Onboarding
│   ├── controller/
│   │   ├── OnboardingController.java
│   │   ├── OnboardingMaterialController.java
│   │   └── OnboardingTaskController.java
│   ├── service/
│   │   ├── OnboardingService.java
│   │   ├── OnboardingMaterialService.java
│   │   └── OnboardingTaskService.java
│   ├── integration/
│   │   └── EmployeeCreationIntegration.java
│   ├── mapper/
│   │   ├── OnboardingMapper.java
│   │   ├── OnboardingMaterialMapper.java
│   │   └── OnboardingTaskMapper.java
│   ├── entity/
│   │   ├── Onboarding.java
│   │   ├── OnboardingMaterial.java
│   │   └── OnboardingTask.java
│   └── dto/
│       ├── OnboardingDTO.java
│       ├── OnboardingMaterialDTO.java
│       └── OnboardingTaskDTO.java
│
├── attendance/                       # M05 考勤假勤
│   ├── controller/
│   │   ├── ShiftController.java
│   │   ├── AttendanceRuleController.java
│   │   ├── AttendanceController.java
│   │   ├── LeaveTypeController.java
│   │   ├── LeaveController.java
│   │   └── OvertimeController.java
│   ├── service/
│   │   ├── ShiftService.java
│   │   ├── AttendanceRuleService.java
│   │   ├── AttendanceService.java
│   │   ├── LeaveTypeService.java
│   │   ├── LeaveBalanceService.java
│   │   ├── LeaveRequestService.java
│   │   └── OvertimeService.java
│   ├── statemachine/
│   │   ├── LeaveRequestStateMachine.java
│   │   └── OvertimeRequestStateMachine.java
│   ├── calculator/
│   │   └── AttendanceCalculator.java
│   ├── mapper/
│   │   ├── AttendanceShiftMapper.java
│   │   ├── AttendanceRuleMapper.java
│   │   ├── AttendanceRecordMapper.java
│   │   ├── LeaveTypeMapper.java
│   │   ├── LeaveBalanceMapper.java
│   │   ├── LeaveRequestMapper.java
│   │   └── OvertimeRequestMapper.java
│   ├── entity/
│   │   ├── AttendanceShift.java
│   │   ├── AttendanceRule.java
│   │   ├── AttendanceRecord.java
│   │   ├── LeaveType.java
│   │   ├── LeaveBalance.java
│   │   ├── LeaveRequest.java
│   │   └── OvertimeRequest.java
│   └── dto/
│       ├── ShiftDTO.java
│       ├── AttendanceRuleDTO.java
│       ├── AttendanceRecordDTO.java
│       ├── LeaveTypeDTO.java
│       ├── LeaveBalanceDTO.java
│       ├── LeaveRequestDTO.java
│       ├── OvertimeRequestDTO.java
│       └── AttendanceSummaryDTO.java
│
├── payroll/                          # M06 薪酬薪资
│   ├── controller/
│   │   ├── SalaryItemController.java
│   │   ├── SalaryArchiveController.java
│   │   ├── PayrollRunController.java
│   │   └── PayslipController.java
│   ├── service/
│   │   ├── SalaryItemService.java
│   │   ├── SalaryArchiveService.java
│   │   ├── PayrollRunService.java
│   │   ├── PayrollCalculator.java
│   │   ├── TaxCalculator.java
│   │   ├── SocialSecurityCalculator.java
│   │   └── PayslipService.java
│   ├── statemachine/
│   │   └── PayrollRunStateMachine.java
│   ├── integration/
│   │   └── AttendancePayrollIntegration.java
│   ├── mapper/
│   │   ├── SalaryItemMapper.java
│   │   ├── SalaryArchiveMapper.java
│   │   ├── PayrollRunMapper.java
│   │   ├── PayrollDetailMapper.java
│   │   └── PayslipMapper.java
│   ├── entity/
│   │   ├── SalaryItem.java
│   │   ├── SalaryArchive.java
│   │   ├── PayrollRun.java
│   │   ├── PayrollDetail.java
│   │   └── Payslip.java
│   └── dto/
│       ├── SalaryItemDTO.java
│       ├── SalaryArchiveDTO.java
│       ├── PayrollRunDTO.java
│       ├── PayrollDetailDTO.java
│       └── PayslipDTO.java
│
├── performance/                      # M07 绩效管理
│   ├── controller/
│   │   ├── PerformanceCycleController.java
│   │   ├── PerformanceGoalController.java
│   │   ├── PerformanceReviewController.java
│   │   └── PerformanceResultController.java
│   ├── service/
│   │   ├── PerformanceCycleService.java
│   │   ├── PerformanceGoalService.java
│   │   ├── PerformanceReviewService.java
│   │   ├── PerformanceResultService.java
│   │   └── CalibrationService.java
│   ├── statemachine/
│   │   └── PerformanceCycleStateMachine.java
│   ├── ai/
│   │   └── PerformanceCommentGenerator.java
│   ├── integration/
│   │   └── PerformanceAIIntegration.java
│   ├── mapper/
│   │   ├── PerformanceCycleMapper.java
│   │   ├── PerformanceGoalMapper.java
│   │   ├── PerformanceReviewMapper.java
│   │   └── PerformanceResultMapper.java
│   ├── entity/
│   │   ├── PerformanceCycle.java
│   │   ├── PerformanceGoal.java
│   │   ├── PerformanceReview.java
│   │   └── PerformanceResult.java
│   └── dto/
│       ├── PerformanceCycleDTO.java
│       ├── PerformanceGoalDTO.java
│       ├── PerformanceReviewDTO.java
│       ├── PerformanceResultDTO.java
│       └── CalibrationDTO.java
│
├── ticket/                           # M08 工单系统
│   ├── controller/
│   │   ├── TicketTypeController.java
│   │   ├── TicketController.java
│   │   └── KnowledgeArticleController.java
│   ├── service/
│   │   ├── TicketTypeService.java
│   │   ├── TicketService.java
│   │   ├── TicketCommentService.java
│   │   ├── TicketRoutingService.java
│   │   └── KnowledgeArticleService.java
│   ├── statemachine/
│   │   └── TicketStateMachine.java
│   ├── ai/
│   │   ├── TicketRouterAgent.java
│   │   └── TicketAnswerAgent.java
│   ├── mapper/
│   │   ├── TicketTypeMapper.java
│   │   ├── TicketMapper.java
│   │   ├── TicketCommentMapper.java
│   │   └── KnowledgeArticleMapper.java
│   ├── entity/
│   │   ├── TicketType.java
│   │   ├── Ticket.java
│   │   ├── TicketComment.java
│   │   └── KnowledgeArticle.java
│   └── dto/
│       ├── TicketTypeDTO.java
│       ├── TicketDTO.java
│       ├── TicketCreateDTO.java
│       ├── TicketCommentDTO.java
│       └── KnowledgeArticleDTO.java
│
├── report/                           # M09 报表与分析
│   ├── controller/
│   │   ├── ReportController.java
│   │   └── DashboardController.java
│   ├── service/
│   │   ├── ReportConfigService.java
│   │   ├── ReportDataService.java
│   │   ├── DashboardService.java
│   │   ├── reports/
│   │   │   ├── HeadcountReportService.java
│   │   │   ├── TurnoverReportService.java
│   │   │   ├── AttendanceReportService.java
│   │   │   ├── PayrollReportService.java
│   │   │   └── PerformanceReportService.java
│   │   └── export/
│   │       ├── ExcelExporter.java
│   │       └── PdfExporter.java
│   ├── mapper/
│   │   ├── ReportConfigMapper.java
│   │   └── DashboardConfigMapper.java
│   ├── entity/
│   │   ├── ReportConfig.java
│   │   └── DashboardConfig.java
│   └── dto/
│       ├── ReportConfigDTO.java
│       ├── ReportDataDTO.java
│       ├── DashboardDTO.java
│       └── WidgetDataDTO.java
│
├── ai/                               # M10 AI能力中心
│   ├── controller/
│   │   ├── AIChatController.java
│   │   ├── AIInsightController.java
│   │   ├── AISuggestionController.java
│   │   ├── AIActionController.java
│   │   ├── AIAuditController.java
│   │   └── WhatIfController.java
│   │
│   ├── service/
│   │   ├── chat/
│   │   │   ├── ChatService.java
│   │   │   ├── StreamingChatService.java
│   │   │   └── ChatHistoryService.java
│   │   ├── insight/
│   │   │   ├── TeamOverviewService.java
│   │   │   ├── StabilityAnalysisService.java
│   │   │   ├── OrgHealthService.java
│   │   │   ├── HeadcountAnalysisService.java
│   │   │   └── TurnoverRiskService.java
│   │   ├── suggestion/
│   │   │   ├── SuggestionPoolService.java
│   │   │   ├── SuggestionGeneratorService.java
│   │   │   └── WhatIfSimulationService.java
│   │   ├── action/
│   │   │   ├── AIActionService.java
│   │   │   └── AIActionExecutor.java
│   │   └── audit/
│   │       └── AIOutputAuditService.java
│   │
│   ├── agents/
│   │   ├── base/
│   │   │   ├── AbstractAgent.java
│   │   │   ├── AgentContext.java
│   │   │   └── AgentResponse.java
│   │   ├── impl/
│   │   │   ├── HRPolicyAgent.java
│   │   │   ├── AnalyticsAgent.java
│   │   │   ├── PayrollExplainerAgent.java
│   │   │   └── PerformanceCommentAgent.java
│   │   └── router/
│   │       └── AgentRouter.java
│   │
│   ├── rag/
│   │   ├── EmbeddingService.java
│   │   ├── VectorStoreService.java
│   │   └── RAGService.java
│   │
│   ├── memory/
│   │   ├── ShortTermMemory.java
│   │   └── LongTermMemory.java
│   │
│   ├── tools/
│   │   ├── FunctionRegistry.java
│   │   └── impl/
│   │       ├── SearchKnowledgeFunction.java
│   │       ├── QueryEmployeeFunction.java
│   │       ├── QueryAttendanceFunction.java
│   │       ├── QueryPayrollFunction.java
│   │       ├── QueryPerformanceFunction.java
│   │       ├── CreateTicketFunction.java
│   │       └── AnalyzeDataFunction.java
│   │
│   ├── action/
│   │   ├── ActionHandler.java
│   │   └── handlers/
│   │       ├── CreateRequisitionHandler.java
│   │       ├── CreateEventHandler.java
│   │       ├── CreateTicketHandler.java
│   │       └── SendNotificationHandler.java
│   │
│   ├── mapper/
│   │   ├── AISuggestionMapper.java
│   │   ├── AIActionMapper.java
│   │   ├── AIAuditLogMapper.java
│   │   └── WhatIfSimulationMapper.java
│   │
│   ├── entity/
│   │   ├── AISuggestion.java
│   │   ├── AIAction.java
│   │   ├── AIAuditLog.java
│   │   └── WhatIfSimulation.java
│   │
│   └── dto/
│       ├── ChatRequestDTO.java
│       ├── ChatResponseDTO.java
│       ├── InsightDTO.java
│       ├── SuggestionDTO.java
│       ├── ActionDTO.java
│       └── WhatIfRequestDTO.java
│
└── integration/                      # 模块联动（Phase 6）
    ├── event/
    │   ├── DomainEvent.java
    │   ├── HeadcountChangedEvent.java
    │   ├── OfferAcceptedEvent.java
    │   ├── OnboardingCompletedEvent.java
    │   ├── PerformanceCycleCompletedEvent.java
    │   └── SuggestionAdoptedEvent.java
    │
    └── listener/
        ├── HeadcountRecruitingIntegration.java
        ├── OfferOnboardingIntegration.java
        ├── OnboardingEmployeeIntegration.java
        ├── AttendancePayrollIntegration.java
        └── PerformanceAIIntegration.java
```

---

## 分层说明

### Controller 层

- 接收 HTTP 请求
- 参数校验
- 调用 Service
- 返回 Result 响应

```java
@RestController
@RequestMapping("/api/hr/employees")
@RequiredArgsConstructor
public class EmployeeController {

    private final EmployeeService employeeService;

    @GetMapping
    public Result<PageResult<EmployeeDTO>> list(EmployeeQueryDTO query) {
        return Result.success(employeeService.page(query));
    }

    @GetMapping("/{id}")
    public Result<EmployeeDTO> detail(@PathVariable Long id) {
        return Result.success(employeeService.getById(id));
    }

    @PostMapping
    @RequirePermission("hr:employee:write")
    @AuditLog(module = "员工管理", action = "创建")
    public Result<Long> create(@Valid @RequestBody EmployeeCreateDTO dto) {
        return Result.success(employeeService.create(dto));
    }
}
```

### Service 层

- 业务逻辑处理
- 事务管理
- 调用 Mapper
- 调用其他 Service

```java
@Service
@RequiredArgsConstructor
public class EmployeeServiceImpl implements EmployeeService {

    private final EmployeeMapper employeeMapper;
    private final EmployeeDetailMapper employeeDetailMapper;
    private final HeadcountService headcountService;
    private final ApplicationEventPublisher eventPublisher;

    @Override
    @Transactional
    public Long create(EmployeeCreateDTO dto) {
        // 业务校验
        validateEmployeeCode(dto.getEmployeeCode());

        // 创建员工
        Employee employee = EmployeeConverter.toEntity(dto);
        employee.setTenantId(TenantContext.getTenantId());
        employeeMapper.insert(employee);

        // 创建详情
        if (dto.getDetail() != null) {
            EmployeeDetail detail = EmployeeDetailConverter.toEntity(dto.getDetail());
            detail.setEmployeeId(employee.getId());
            employeeDetailMapper.insert(detail);
        }

        // 更新编制
        headcountService.incrementCurrentCount(dto.getOrgUnitId(), dto.getPositionId());

        return employee.getId();
    }
}
```

### Mapper 层

- MyBatis Plus 数据访问
- 自定义 SQL 查询

```java
@Mapper
public interface EmployeeMapper extends BaseMapper<Employee> {

    @Select("""
        SELECT e.*, d.unit_name as org_unit_name, p.position_name
        FROM employees e
        LEFT JOIN org_units d ON e.org_unit_id = d.id
        LEFT JOIN positions p ON e.position_id = p.id
        WHERE e.tenant_id = #{tenantId}
        AND e.deleted = 0
        """)
    List<EmployeeVO> selectWithOrgAndPosition(@Param("tenantId") String tenantId);
}
```

### Entity 层

- 数据库实体映射
- 使用 Lombok 简化代码

```java
@Data
@TableName("employees")
public class Employee {

    @TableId(type = IdType.AUTO)
    private Long id;

    private String tenantId;
    private String employeeCode;
    private Long sysUserId;
    private String realName;
    private Integer gender;
    private LocalDate birthDate;
    private String idCard;
    private String phone;
    private String email;
    private Long orgUnitId;
    private Long positionId;
    private Long directManagerId;
    private LocalDate entryDate;
    private LocalDate regularizationDate;
    private LocalDate contractStart;
    private LocalDate contractEnd;
    private String employeeStatus;
    private String workLocation;

    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;

    @TableLogic
    private Integer deleted;
}
```

### DTO 层

- 数据传输对象
- 请求/响应参数封装

```java
@Data
public class EmployeeDTO {
    private Long id;
    private String employeeCode;
    private String realName;
    private Integer gender;
    private String genderText;
    private String phone;
    private String email;
    private Long orgUnitId;
    private String orgUnitName;
    private Long positionId;
    private String positionName;
    private LocalDate entryDate;
    private String employeeStatus;
    private String employeeStatusText;
}

@Data
public class EmployeeCreateDTO {
    @NotBlank(message = "工号不能为空")
    private String employeeCode;

    @NotBlank(message = "姓名不能为空")
    private String realName;

    private Integer gender;

    @NotNull(message = "部门不能为空")
    private Long orgUnitId;

    @NotNull(message = "岗位不能为空")
    private Long positionId;

    @NotNull(message = "入职日期不能为空")
    private LocalDate entryDate;

    private EmployeeDetailDTO detail;
}
```

---

## 文件统计

| 模块 | Controller | Service | Mapper | Entity | DTO | 其他 |
|------|------------|---------|--------|--------|-----|------|
| org | 4 | 5 | 6 | 6 | 6 | - |
| hr | 4 | 4 | 5 | 5 | 6 | 3(状态机) |
| recruiting | 4 | 7 | 7 | 7 | 6 | 4(状态机)+2(AI) |
| onboarding | 3 | 3 | 3 | 3 | 3 | 1(集成) |
| attendance | 6 | 7 | 7 | 7 | 8 | 2(状态机)+1(计算器) |
| payroll | 4 | 7 | 5 | 5 | 5 | 2(计算器)+1(集成) |
| performance | 4 | 5 | 4 | 4 | 5 | 1(状态机)+1(AI)+1(集成) |
| ticket | 3 | 5 | 4 | 4 | 5 | 1(状态机)+2(AI) |
| report | 2 | 8 | 2 | 2 | 4 | 2(导出) |
| ai | 6 | 12 | 4 | 4 | 6 | 4(Agent)+7(Function)+4(Handler) |
| integration | - | - | - | - | - | 5(事件)+5(监听) |
| **总计** | **40** | **63** | **47** | **47** | **54** | **~50** |

---

*本文档描述了后端完整的包结构设计，总计约 300+ Java 文件*
