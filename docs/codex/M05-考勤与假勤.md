# M05 考勤与假勤 - 实现方案

## 模块范围与页面
以下页面来源于需求清单，作为前后端实现的基准。

| 需求ID | PageID | 功能 | 页面类型 | 页面/区块 | 按钮/操作 | 关键字段 | 校验/规则 | 状态/口径 | 输入/输出 | 异常索引 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| RQ0034 | PG0034 | 班次/考勤规则配置 | 配置页 | 班次列表；适用范围；规则参数 | 新增班次；编辑；停用；绑定组织/岗位；导出 | 班次名, 上下班时间, 休息, 迟到阈值(可选), 适用范围 | 时间格式校验；停用不影响历史；范围冲突提示(可选) | — | ShiftRule(读写), OrgUnit/Position(读) | EX0001,EX0002,EX0003 |
| RQ0035 | PG0035 | 打卡记录 | 列表页 | 筛选(日期/组织/员工/异常)；列表；异常统计 | 导入(可选)；导出；查看详情；发起补卡(V2可增强) | 员工, 日期, 上班打卡, 下班打卡, 异常标识 | 人员匹配(工号)；异常规则依据班次；导出字段遵循权限 | — | TimeRecord(读写) | EX0001,EX0019 |
| RQ0036 | PG0036 | 请假管理 | 员工端-请假创建页 | 请假表单；余额提示；审批流预览 | 保存草稿；提交审批；取消 | 假种, 开始/结束时间, 时长(自动), 原因, 附件(可选) | 时间区间校验；余额校验；跨天计算口径(按班次)；与加班冲突提示(可选) | 状态：草稿/审批中/已批准/驳回/撤回/销假(可选) | LeaveRequest(读写), LeaveQuota(读) | EX0001,EX0020,EX0003 |
| RQ0037 | PG0037 | 请假管理 | 审批页(审批人待办) | 待办列表；详情抽屉(含余额/影响提示) | 同意；驳回；转交(可选) | 请假单字段+余额+影响提示 | 驳回必填原因；同意后写入汇总 | — | WorkflowInstance(读写), LeaveRequest(读写) | EX0001 |
| RQ0038 | PG0038 | 请假管理 | HR端-请假列表/导出 | 筛选(组织/假种/状态/日期)；列表；统计 | 导出；批量审批(可选)；查看详情 | 员工, 假种, 时长, 状态, 审批人, 申请时间 | 导出字段权限控制；统计口径一致 | — | LeaveRequest(读), LeaveQuota(读) | EX0001 |
| RQ0039 | PG0039 | 加班管理 | 员工端-加班创建页 | 加班表单；冲突提示；审批流预览 | 保存草稿；提交审批；取消 | 开始/结束时间, 时长(自动), 原因, 附件(可选) | 时间区间校验；冲突检测(可选)；时长计算口径 | 状态：草稿/审批中/已批准/驳回/撤回 | OvertimeRequest(读写) | EX0001,EX0021 |

## 前端实现方案
- 路由与菜单：按 PageID 建路由与菜单分组，详情/创建页按列表页入口跳转。
- 页面结构：以需求中的“页面/区块”为信息架构，表单/表格字段由页面字段表驱动渲染。
- 按钮与权限：按钮集合以“按钮/操作”为准，按钮级权限点从按钮字典同步；字段级权限动态隐藏/脱敏。
- 交互校验：前端执行必填/格式/枚举校验，并在提交时提示后端返回的业务校验错误。
- 导入/导出：统一上传/导出组件；大结果集提示异步导出。
页面清单：
- PG0034 班次/考勤规则配置（配置页）：班次列表；适用范围；规则参数
- PG0035 打卡记录（列表页）：筛选(日期/组织/员工/异常)；列表；异常统计
- PG0036 请假管理（员工端-请假创建页）：请假表单；余额提示；审批流预览
- PG0037 请假管理（审批页(审批人待办)）：待办列表；详情抽屉(含余额/影响提示)
- PG0038 请假管理（HR端-请假列表/导出）：筛选(组织/假种/状态/日期)；列表；统计
- PG0039 加班管理（员工端-加班创建页）：加班表单；冲突提示；审批流预览

## 后端实现方案
- 领域对象（建议）：ShiftRule、AttendanceRecord、LeaveRequest、OvertimeRequest、LeaveBalance
- API 设计：按页面“按钮/操作”映射 CRUD/状态变更/导入导出/审批动作；列表页必须支持分页与多条件筛选。
- 校验与规则：后端强校验业务规则与并发版本（见下方“关键规则/异常”）。
- 权限与审计：RBAC + 组织范围（行级）+ 字段级权限；关键写操作写入审计日志。
- 幂等与一致性：对导入/批量操作提供幂等 token；审批/状态变更防重。

## 状态机
- LeaveRequest(请假)
  - 草稿 -> 审批中（操作：提交/删除；角色：员工/审批人/HR）
  - 审批中 -> 已批准/已驳回/已撤回（操作：同意/驳回/撤回；角色：员工/审批人/HR）
  - 已批准 -> 已销假/已撤销（操作：销假(可选)/撤销(可选)；角色：员工/审批人/HR）
  - 已驳回 -> 审批中（操作：修改后提交；角色：员工/审批人/HR）
- OvertimeRequest(加班)
  - 草稿 -> 审批中（操作：提交；角色：员工）
  - 审批中 -> 已批准/已驳回/已撤回（操作：同意/驳回/撤回；角色：审批人）

## 模块联动
- LK0004：上游 M05 考勤与假勤 -> M06 薪资；触发=月度考勤汇总生成；读写=读: AttendanceSummary写入算薪批次；规则=汇总口径统一：按班次计算时长/天数

## 关键规则
- 时间格式校验；停用不影响历史；范围冲突提示(可选)
- 人员匹配(工号)；异常规则依据班次；导出字段遵循权限
- 时间区间校验；余额校验；跨天计算口径(按班次)；与加班冲突提示(可选)
- 驳回必填原因；同意后写入汇总
- 导出字段权限控制；统计口径一致
- 时间区间校验；冲突检测(可选)；时长计算口径

## 异常场景
- EX0001：越权访问/返回敏感字段（用户无行级或字段级权限）
- EX0002：并发修改导致覆盖（两人同时编辑同一记录）
- EX0003：必填字段缺失（提交时必填为空）
- EX0019：打卡导入失败（格式错误/人员匹配失败）
- EX0020：假期余额不足（申请时余额<申请量）
- EX0021：加班与请假/排班冲突（申请时间与请假或非工作日规则冲突）

## 验收与测试要点
- 绑定后对应员工考勤按该规则计算
- 导入后记录可查询；异常标识符合规则
- 提交后进入审批中；审批通过后占用余额并反映到月度汇总
- 审批动作后申请单状态变化正确；员工收到通知
- 导出与统计符合筛选条件；权限正确
- 审批通过后月度汇总加班时长增加
