# M01 组织与权限 - 实现方案

## 模块范围与页面
以下页面来源于需求清单，作为前后端实现的基准。

| 需求ID | PageID | 功能 | 页面类型 | 页面/区块 | 按钮/操作 | 关键字段 | 校验/规则 | 状态/口径 | 输入/输出 | 异常索引 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| RQ0001 | PG0001 | 组织单元管理 | 列表(组织树) | 左侧组织树；右侧组织详情摘要/统计卡片(可选) | 新增组织；编辑；停用/启用；移动(调整上级)；导入(可选)；导出 | 组织名称, 组织编码, 上级组织, 负责人, 状态 | 编码唯一(同父级)；停用组织需无在职员工(或要求迁移)；移动需防环；变更留痕 | 组织状态: 启用/停用 | OrgUnit(读写) | EX0001,EX0004,EX0005,EX0002 |
| RQ0002 | PG0002 | 组织单元管理 | 详情页 | 基础信息区；下属组织列表；岗位列表(只读链接)；在职员工列表(只读链接) | 编辑；停用/启用；查看变更历史；导出本组织员工(按权限) | 组织名称, 编码, 负责人, 上级, 描述, 状态, 创建/更新时间 | 停用需校验无未完成流程；变更记录需可回溯 | — | OrgUnit(读写), Position(读), Employee(读) | EX0001 |
| RQ0003 | PG0003 | 用户/角色管理 | 列表页 | 用户列表；筛选(组织/角色/状态)；批量操作区 | 新增用户；编辑；启用/停用；重置密码(可选)；分配角色；导出 | 账号, 姓名, 关联员工(可选), 角色, 组织范围, 状态, 最近登录 | 停用用户不得删除历史记录；角色变更即时生效；操作留痕 | 用户状态: 启用/停用 | User(读写), Role(读写) | EX0006,EX0002 |
| RQ0004 | PG0004 | 用户/角色管理 | 详情页 | 用户信息；角色与范围；字段权限(敏感字段开关)；登录与审计摘要 | 编辑信息；调整角色/范围；锁定/解锁；查看操作日志 | 账号, 姓名, 角色, 组织范围, 字段权限集, 状态 | 范围不得超出管理员可管理范围；字段权限变更需记录 | — | User(读写), PermissionPolicy(读写), AuditLog(读) | EX0001 |
| RQ0005 | PG0005 | 审计日志 | 列表页 | 筛选(操作者/对象/时间/动作)；日志列表；详情抽屉 | 导出；查看详情 | 操作者, 时间, 对象类型, 对象ID, 动作, 变更摘要 | 日志不可修改/删除；导出遵循审计权限 | — | AuditLog(读) | EX0001 |

## 前端实现方案
- 路由与菜单：按 PageID 建路由与菜单分组，详情/创建页按列表页入口跳转。
- 页面结构：以需求中的“页面/区块”为信息架构，表单/表格字段由页面字段表驱动渲染。
- 按钮与权限：按钮集合以“按钮/操作”为准，按钮级权限点从按钮字典同步；字段级权限动态隐藏/脱敏。
- 交互校验：前端执行必填/格式/枚举校验，并在提交时提示后端返回的业务校验错误。
- 导入/导出：统一上传/导出组件；大结果集提示异步导出。
页面清单：
- PG0001 组织单元管理（列表(组织树)）：左侧组织树；右侧组织详情摘要/统计卡片(可选)
- PG0002 组织单元管理（详情页）：基础信息区；下属组织列表；岗位列表(只读链接)；在职员工列表(只读链接)
- PG0003 用户/角色管理（列表页）：用户列表；筛选(组织/角色/状态)；批量操作区
- PG0004 用户/角色管理（详情页）：用户信息；角色与范围；字段权限(敏感字段开关)；登录与审计摘要
- PG0005 审计日志（列表页）：筛选(操作者/对象/时间/动作)；日志列表；详情抽屉

## 后端实现方案
- 领域对象（建议）：OrgUnit、User、Role、PermissionPolicy、AuditLog
- API 设计：按页面“按钮/操作”映射 CRUD/状态变更/导入导出/审批动作；列表页必须支持分页与多条件筛选。
- 校验与规则：后端强校验业务规则与并发版本（见下方“关键规则/异常”）。
- 权限与审计：RBAC + 组织范围（行级）+ 字段级权限；关键写操作写入审计日志。
- 幂等与一致性：对导入/批量操作提供幂等 token；审批/状态变更防重。

## 关键规则
- 编码唯一(同父级)；停用组织需无在职员工(或要求迁移)；移动需防环；变更留痕
- 停用需校验无未完成流程；变更记录需可回溯
- 停用用户不得删除历史记录；角色变更即时生效；操作留痕
- 范围不得超出管理员可管理范围；字段权限变更需记录
- 日志不可修改/删除；导出遵循审计权限

## 异常场景
- EX0001：越权访问/返回敏感字段（用户无行级或字段级权限）
- EX0004：组织编码/名称重复（同一父级下编码或名称重复）
- EX0005：组织结构形成环（将组织上级设置为自身/子孙节点）
- EX0002：并发修改导致覆盖（两人同时编辑同一记录）
- EX0006：账号/手机号/邮箱重复（创建用户时主键重复）
- EX0003：必填字段缺失（提交时必填为空）

## 验收与测试要点
- 新增/编辑/停用后，组织树实时刷新；审计日志可追溯
- 详情页展示组织下属与关联关系；链接可跳转且遵循权限
- 角色分配后，受控模块立即按新权限生效；导出包含可见字段
- 修改后在任一业务页面验证字段是否按权限隐藏/脱敏
- 任意关键操作(如调薪)在日志中可检索并查看前后值
