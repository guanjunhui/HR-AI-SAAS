# M06 薪酬与薪资 - 实现方案

## 模块范围与页面
以下页面来源于需求清单，作为前后端实现的基准。

| 需求ID | PageID | 功能 | 页面类型 | 页面/区块 | 按钮/操作 | 关键字段 | 校验/规则 | 状态/口径 | 输入/输出 | 异常索引 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| RQ0040 | PG0040 | 薪酬项目配置 | 配置页 | 薪酬项目列表；项目类型(加/减/税前税后可选)；启用状态 | 新增项目；编辑；停用；排序；导出 | 项目名, 类型(收入/扣款), 计算方式(固定/公式), 状态 | 项目名唯一；停用不影响历史；公式合法性校验(若支持) | — | PayItem(读写) | EX0001 |
| RQ0041 | PG0041 | 员工薪资档案 | 列表页 | 员工列表(仅薪资可见)；快速编辑入口；生效日期提示 | 编辑薪资档案；导入(可选)；导出 | 员工, 薪资组(可选), 生效日期, 基本工资, 津贴合计(可选) | 字段级权限严格；变更需生效日期并留痕 | — | CompProfile(读写), Employee(读) | EX0001,EX0022 |
| RQ0042 | PG0042 | 算薪批次管理 | 列表页 | 批次列表；期间；状态；统计(总人数/总额可选) | 新建批次；导入考勤；计算；提交复核；封账；生成工资条；导出发薪 | 期间, 状态, 人数, 总额(可选), 创建人 | 状态机约束；期间不可重叠(同薪资组)；封账后只读 | 状态：草稿/复核中/已退回/已封账 | PayrollRun(读写), AttendanceSummary(读), CompProfile(读) | EX0001,EX0023,EX0002 |
| RQ0043 | PG0043 | 算薪批次管理 | 批次详情页(明细预览) | 员工明细表；项目明细；差异提示；错误行提示 | 重新计算；导出明细；提交复核；封账 | 员工, 薪资项目列, 应发/应扣, 实发(可选) | 错误行需提示原因；封账后按钮置灰 | — | PayrollRun(读写), PayrollLine(读) | EX0001,EX0023 |
| RQ0044 | PG0044 | 工资条 | 员工端-工资条列表 | 按期间列表；状态(已发布/未发布) | 查看详情；下载(可选) | 期间, 实发, 明细(可展开) | 仅发布后员工可见；敏感字段控制 | — | Payslip(读) | EX0001,EX0022 |

## 前端实现方案
- 路由与菜单：按 PageID 建路由与菜单分组，详情/创建页按列表页入口跳转。
- 页面结构：以需求中的“页面/区块”为信息架构，表单/表格字段由页面字段表驱动渲染。
- 按钮与权限：按钮集合以“按钮/操作”为准，按钮级权限点从按钮字典同步；字段级权限动态隐藏/脱敏。
- 交互校验：前端执行必填/格式/枚举校验，并在提交时提示后端返回的业务校验错误。
- 导入/导出：统一上传/导出组件；大结果集提示异步导出。
页面清单：
- PG0040 薪酬项目配置（配置页）：薪酬项目列表；项目类型(加/减/税前税后可选)；启用状态
- PG0041 员工薪资档案（列表页）：员工列表(仅薪资可见)；快速编辑入口；生效日期提示
- PG0042 算薪批次管理（列表页）：批次列表；期间；状态；统计(总人数/总额可选)
- PG0043 算薪批次管理（批次详情页(明细预览)）：员工明细表；项目明细；差异提示；错误行提示
- PG0044 工资条（员工端-工资条列表）：按期间列表；状态(已发布/未发布)

## 后端实现方案
- 领域对象（建议）：PayrollItem、SalaryProfile、PayrollRun、Payslip
- API 设计：按页面“按钮/操作”映射 CRUD/状态变更/导入导出/审批动作；列表页必须支持分页与多条件筛选。
- 校验与规则：后端强校验业务规则与并发版本（见下方“关键规则/异常”）。
- 权限与审计：RBAC + 组织范围（行级）+ 字段级权限；关键写操作写入审计日志。
- 幂等与一致性：对导入/批量操作提供幂等 token；审批/状态变更防重。

## 状态机
- PayrollRun(算薪批次)
  - 草稿 -> 复核中（操作：导入考勤/计算/提交复核；角色：HR/财务(可选)）
  - 复核中 -> 已封账/已退回（操作：确认/退回；角色：HR/财务(可选)）
  - 已退回 -> 复核中（操作：调整后重新计算；角色：HR/财务(可选)）
  - 已封账 -> 已封账（操作：生成工资条/导出发薪；角色：HR/财务(可选)）

## 模块联动
- LK0004：下游 M05 考勤与假勤 -> M06 薪资；触发=月度考勤汇总生成；读写=读: AttendanceSummary写入算薪批次；规则=汇总口径统一：按班次计算时长/天数

## 关键规则
- 项目名唯一；停用不影响历史；公式合法性校验(若支持)
- 字段级权限严格；变更需生效日期并留痕
- 状态机约束；期间不可重叠(同薪资组)；封账后只读
- 错误行需提示原因；封账后按钮置灰
- 仅发布后员工可见；敏感字段控制

## 异常场景
- EX0001：越权访问/返回敏感字段（用户无行级或字段级权限）
- EX0022：无权查看/编辑薪资（非薪资权限用户访问）
- EX0023：封账后试图修改（批次状态=已封账）
- EX0002：并发修改导致覆盖（两人同时编辑同一记录）
- EX0003：必填字段缺失（提交时必填为空）

## 验收与测试要点
- 新增项目可被添加到员工薪资档案并参与算薪
- 不同生效日期档案可回溯；仅有权限者可见
- 计算后明细可预览；封账后工资条可查看且不可篡改
- 任意员工工资条与批次明细一致
- 员工仅能查看本人；数据与批次一致
