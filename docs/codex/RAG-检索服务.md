# RAG 检索服务 - 实现方案

## 模块范围与页面
该模块用于“文件/知识维护 + 向量索引 + 检索服务”，默认仅对内提供给 AI 能力中心调用。

| 需求ID | PageID | 功能 | 页面类型 | 页面/区块 | 按钮/操作 | 关键字段 | 校验/规则 | 状态/口径 | 输入/输出 | 异常索引 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| RAG001 | PG-RAG-01 | 知识文档管理 | 列表页 | 过滤(类型/分类/状态)；文档列表；索引状态 | 上传；解析；重建索引；下线/删除；导出 | 文档标题, 类型, 分类, 状态, 索引状态, 更新时间 | 文件类型/大小校验；重复检测；下线不删除历史索引(可配) | 文档状态：草稿/已发布/已下线 | KnowledgeDoc(读写) | EX0001,EX0003,EX0031 |
| RAG002 | PG-RAG-02 | 文档详情与切片 | 详情页 | 文档元数据；切片列表；向量状态 | 查看切片；重切片；重索引 | 切片内容, chunk_index, 向量状态 | 切片内容长度限制；仅管理员可操作 | — | KnowledgeChunk(读) | EX0001 |
| RAG003 | PG-RAG-03 | 索引管理 | 运维页 | 索引列表；任务队列；失败重试 | 重建索引；暂停/恢复 | 索引名, 任务状态, 失败原因 | 仅管理员可操作；任务幂等 | 任务状态：待处理/进行中/成功/失败 | IndexTask(读写) | EX0001,EX0032 |

## 前端实现方案
- 页面以“文档列表 + 索引状态”为核心；批量重建/重解析支持异步任务与进度提示。
- 文档详情提供切片预览与检索命中对齐高亮（可选）。
- 权限：管理员/知识库编辑者可维护；普通用户仅可被动引用。

## 后端实现方案
- 领域对象（建议）：KnowledgeDoc、KnowledgeChunk、IndexTask、VectorIndex。
- API 设计：
  - `POST /rag/knowledge` 上传文档（含元数据）
  - `GET /rag/knowledge` 文档列表（分页/筛选）
  - `DELETE /rag/knowledge/{docId}` 删除/下线
  - `GET /rag/chunks` 切片列表
  - `POST /rag/index` 触发重建索引
  - `POST /rag/search` 向量检索（对内）
- 权限与安全：按租户隔离；`allowed_roles` 控制可见；RAG 搜索必须校验调用方权限。
- 与 AI 的对接：AI 调用 `/rag/search` 获取 TopK 切片与引用元数据，生成回答并输出引用来源。

## 关键规则
- 文档入库后先解析切片，再向量化；重建索引需幂等与可重试。
- 删除/下线不立即物理删除，避免历史引用失效（可配置定时清理）。
- 召回结果必须返回来源信息（doc_id/title/chunk_index）。

## 异常场景
- EX0001：越权访问/返回敏感字段
- EX0003：必填字段缺失/非法格式
- EX0031：文档解析失败（格式不支持/内容为空）
- EX0032：索引任务失败（向量库不可用/超时）

## 验收与测试要点
- 上传文档后能看到解析与索引状态变化；失败原因可追踪。
- 同一文档重建索引结果一致；重复请求具备幂等。
- AI 调用检索时可返回引用来源并按权限过滤。
