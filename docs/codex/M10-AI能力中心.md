# M10 AI 能力中心 - 实现方案

## 模块范围与页面
以下页面来源于需求清单，作为前后端实现的基准。

| 需求ID | PageID | 功能 | 页面类型 | 页面/区块 | 按钮/操作 | 关键字段 | 校验/规则 | 状态/口径 | 输入/输出 | 异常索引 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| RQ0066 | PG0066 | AI 对话助手 | 对话页 | 左侧会话列表；右侧对话区；引用数据卡片；推荐问题 | 新建会话；发送；引用报表；复制答案；导出对话；反馈(赞/踩) | 用户问题, 系统回答, 引用指标卡片(HC/离职/编制等) | 必须展示口径提示/数据时间范围；拒绝越权；不可编造(无数据则提示无数据) | — | AIChat(读写), Metric(读), Policy(读) | EX0001,EX0024,EX0025 |
| RQ0067 | PG0067 | 团队概览总结 | 洞察页 | 选择组织/时间；自动生成摘要；关键指标列表；引用数据 | 生成/刷新；复制；导出PDF(可选)；分享(可选) | 摘要文本, 指标卡片, 异动列表(入离职/调岗等) | 摘要必须引用数据点；默认最近30天；允许用户改范围 | — | AIInsight(读写), Metric(读), EmploymentEvent(读) | EX0001,EX0024,EX0025 |
| RQ0068 | PG0068 | 稳定性/组织健康度分析 | 洞察页(分析增强) | 风险提示区；原因解释；对比图；建议动作区 | 生成；一键创建建议；导出；查看依据 | 离职率趋势, 关键岗位波动, 编制占用, 结构指标(简版) | 判断必须可解释：展示触发阈值/对比基线(可配置)；不做自动定责 | — | AIInsight(读写), Metric(读), Position/Headcount(读) | EX0001,EX0025 |
| RQ0069 | PG0069 | AI 建议与行动 | 建议列表页 | 建议列表；筛选(组织/类型/状态)；影响摘要 | 采纳；忽略；一键执行；导出；查看依据 | 建议类型(招聘/调岗/关注/工单), 状态, 依据摘要, 创建时间 | 采纳/执行需留痕；执行失败需回滚提示 | 建议状态：已生成/已采纳/已忽略/已执行 | AIAction(读写), AIAudit(写) | EX0001 |
| RQ0070 | PG0070 | AI 输出留痕与可解释性 | 留痕审计页 | 查询(用户/时间/场景)；输出内容；引用数据快照；用户反馈 | 导出；标记问题；回溯引用数据 | 问题, 回答, 引用指标, 权限快照, 版本号 | 任何AI输出必须可追溯到数据快照与口径；敏感字段脱敏 | — | AIAudit(读) | EX0001 |
| RQ0071 | PG0071 | 离职风险(解释型)+What-if | 风险看板页 | 风险分布；高风险名单；原因维度；趋势变化 | 生成/刷新；导出；创建跟进工单；标记误报 | 风险等级, 风险原因(Top3), 变化趋势, 建议动作 | 风险必须解释；支持用户反馈修正(标记误报/已沟通) | 风险等级：高/中/低；趋势：上升/下降/稳定 | RiskScore(读写), AIInsight(读), Ticket(写) | EX0001,EX0025 |
| RQ0072 | PG0072 | What-if 模拟 | 模拟页 | 选择场景(不招聘/加编/调岗)；输入参数；输出影响对比 | 运行模拟；保存方案；导出；一键发起执行(可选) | 场景参数：岗位、人数、时间范围、阈值 | 模拟口径固定并可解释；提示“模拟非承诺” | — | Scenario(读写), Metric(读) | EX0001 |

## 前端实现方案
- 路由与菜单：按 PageID 建路由与菜单分组，详情/创建页按列表页入口跳转。
- 页面结构：以需求中的“页面/区块”为信息架构，表单/表格字段由页面字段表驱动渲染。
- 按钮与权限：按钮集合以“按钮/操作”为准，按钮级权限点从按钮字典同步；字段级权限动态隐藏/脱敏。
- 交互校验：前端执行必填/格式/枚举校验，并在提交时提示后端返回的业务校验错误。
- 导入/导出：统一上传/导出组件；大结果集提示异步导出。
页面清单：
- PG0066 AI 对话助手（对话页）：左侧会话列表；右侧对话区；引用数据卡片；推荐问题
- PG0067 团队概览总结（洞察页）：选择组织/时间；自动生成摘要；关键指标列表；引用数据
- PG0068 稳定性/组织健康度分析（洞察页(分析增强)）：风险提示区；原因解释；对比图；建议动作区
- PG0069 AI 建议与行动（建议列表页）：建议列表；筛选(组织/类型/状态)；影响摘要
- PG0070 AI 输出留痕与可解释性（留痕审计页）：查询(用户/时间/场景)；输出内容；引用数据快照；用户反馈
- PG0071 离职风险(解释型)+What-if（风险看板页）：风险分布；高风险名单；原因维度；趋势变化
- PG0072 What-if 模拟（模拟页）：选择场景(不招聘/加编/调岗)；输入参数；输出影响对比

## 后端实现方案
- 领域对象（建议）：AIConversation、AIInsight、AIAction、AIAudit、WhatIfScenario
- API 设计：按页面“按钮/操作”映射 CRUD/状态变更/导入导出/审批动作；列表页必须支持分页与多条件筛选。
- 校验与规则：后端强校验业务规则与并发版本（见下方“关键规则/异常”）。
- 权限与审计：RBAC + 组织范围（行级）+ 字段级权限；关键写操作写入审计日志。
- 幂等与一致性：对导入/批量操作提供幂等 token；审批/状态变更防重。
- RAG 对接：需要检索增强的场景统一调用 `hr-rag-service` 的 `/rag/search`，返回引用来源并按权限过滤。

## 技术实现依赖（Spring AI Alibaba RC2）
- 基础依赖：`spring-ai-alibaba-agent-framework`（替换 `spring-ai-alibaba-starter` + `spring-ai-alibaba-starter-agent`）
- Graph：`spring-ai-alibaba-graph-core`（agent-framework 已传递引入；如需直接调用 Graph API 可显式依赖）
- MCP/A2A：`spring-ai-alibaba-starter-nacos-mcp-server`、`spring-ai-alibaba-starter-a2a-server`、`spring-ai-alibaba-starter-a2a-nacos-discovery`
- 模型接入：`spring-ai-alibaba-starter-dashscope`（已纳入基础依赖）

## 状态机
- AIAction(建议动作)
  - 已生成 -> 已采纳/已忽略/已生成（操作：采纳/忽略/反馈；角色：HR/经理）
  - 已采纳 -> 已执行/已生成（操作：一键执行/取消采纳；角色：HR/经理）
  - 已执行 -> 已执行（操作：查看结果/复盘；角色：HR/经理）

## 模块联动
- LK0005：下游 M07 绩效管理 -> M10 AI 能力中心；触发=绩效结果归档；读写=读: PerformanceResult用于风险/建议；规则=V3离职风险可引用绩效下降趋势(可解释)
- LK0006：上游 M10 AI 能力中心 -> M03 招聘管理；触发=采纳建议: 创建招聘需求；读写=写: JobRequisition；规则=执行前校验编制/权限；失败回滚
- LK0007：上游 M10 AI 能力中心 -> M02 Core HR；触发=采纳建议: 发起调岗/调薪流程；读写=写: EmploymentEvent；规则=执行前校验生效日期/编制/权限
- LK0008：上游 M10 AI 能力中心 -> M08 工单；触发=采纳建议: 创建跟进工单；读写=write: Ticket；规则=自动带入建议原因与证据

## 关键规则
- 必须展示口径提示/数据时间范围；拒绝越权；不可编造(无数据则提示无数据)
- 摘要必须引用数据点；默认最近30天；允许用户改范围
- 判断必须可解释：展示触发阈值/对比基线(可配置)；不做自动定责
- 采纳/执行需留痕；执行失败需回滚提示
- 任何AI输出必须可追溯到数据快照与口径；敏感字段脱敏
- 风险必须解释；支持用户反馈修正(标记误报/已沟通)
- 模拟口径固定并可解释；提示“模拟非承诺”

## 异常场景
- EX0001：越权访问/返回敏感字段（用户无行级或字段级权限）
- EX0024：查询无数据或口径不一致（筛选范围内无记录/指标口径缺失）
- EX0025：AI 输出包含敏感字段（模型生成或引用包含受限字段）
- EX0003：必填字段缺失（提交时必填为空）

## 验收与测试要点
- 同一问题在相同权限下结果一致；引用卡片可跳转到对应报表/明细
- 摘要包含至少3个数据点；点击可下钻到明细
- 每条结论均附“依据数据”；建议动作可被采纳/忽略并留痕
- 采纳后可一键执行生成下游记录；执行结果回写状态
- 可定位任一对话/洞察的依据数据与当时权限
- 高风险名单可下钻到员工档案且不越权；误报标记留痕
- 同参数重复运行结果一致；可导出对比表

## AI 场景清单

| SceneID | 场景名称 | 最早版本 | 入口PageID | 触发方式 | 数据来源 | 输出模板 | 可触发动作 | 权限/安全约束 | 异常兜底 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| AI-SC-001 | AI 自然语言查询（员工/组织/事件/指标） | V1 | PG0066 | 对话输入→发送 | M02 Employee/EmploymentHistory/EmploymentEvent；M01 OrgUnit/Position；M09 Metric(如已落库) | 结论一句话；数据要点列表；口径/筛选说明；（可选）建议下一步可问的问题 | 无（仅复制/导出/引用报表） | 行级权限：仅返回授权范围员工；字段级：薪资/绩效脱敏或隐藏；敏感字段默认不在对话输出 | 无匹配实体→澄清问题；数据为空→返回‘未找到’+建议调整筛选；权限不足→提示无权限且不泄露实体存在 |
| AI-SC-002 | AI 政策/制度问答（知识库引用） | V2 | PG0066 | 对话输入→发送（引用知识库） | M08 KBArticle；M01 OrgUnit；（可选）M02 Employee用于匹配政策适用人群 | 简明答案；适用范围；引用来源；相关流程入口（按钮/链接） | 一键创建工单（M08） | 员工仅能看到对其可见的政策版本；禁止输出内部敏感附件内容 | 无知识库/命中率低→提示联系HR并创建工单；条目过期→提示需更新 |
| AI-SC-003 | AI 团队概览自动总结（组织健康基础版） | V1 | PG0067 | 点击生成/刷新 | M02 Employee/EmploymentEvent；M01 OrgUnit/Position；M09 基础统计 | 概览摘要；关键数字卡片；结构要点；异动要点；建议关注事项（不带结论） | 导出PDF/复制；（可选）分享链接 | 仅总结可见范围；敏感字段不进入总结；若团队人数<阈值（如<5）隐藏细分以防推断个体 | 组织为空/无权限→提示；事件为空→输出‘无异动’并显示当前结构 |
| AI-SC-004 | AI 稳定性分析（离职/异动趋势+原因分布） | V2 | PG0068 | 点击生成；或在对话中请求‘稳定性分析’ | M02 EmploymentEvent(离职/异动)/Employee；（可选）M07 绩效结果；M09 指标口径 | 结论摘要；趋势图结论；异常点列表；原因分布；建议动作（可生成建议） | 一键创建建议（进入AI建议池PG0069）；导出 | 管理层仅看汇总；小样本保护；离职原因敏感需按权限显示 | 样本不足→提示建议延长时间范围；原因缺失→提示完善离职原因字段 |
| AI-SC-005 | AI 组织健康度分析（跨度/层级/结构合理性） | V2 | PG0068 | 点击生成；或对话触发‘组织健康’ | M01 OrgUnit(树)/汇报线；M02 Employee/职位；M09 指标 | 健康度评分（可选）；异常结构点；影响说明；建议调整方向（不自动执行） | 生成建议；导出；（可选）创建组织调整方案草稿(V3) | 仅输出用户可见范围；避免暴露个人敏感信息（仅用岗位/组织聚合） | 汇报线缺失→提示先完善汇报关系；组织树异常（循环）→报错并引导修复 |
| AI-SC-006 | AI 编制合理性分析（空缺/超编/招聘优先级） | V2 | PG0068 | 点击生成；或对话触发‘编制合理’ | M02 Position/编制配置；M02 Employee在岗占用；M03 招聘需求(可选，用于在招占用) | 结论摘要；岗位清单表；优先级分组；建议动作（可创建招聘需求） | 一键创建招聘需求（M03）；发起调岗/调编流程（若有） | 仅可对可管理范围创建招聘需求；岗位敏感信息按权限显示 | 未启用编制→提示先开通编制模块；数据不完整→提示补齐岗位编制 |
| AI-SC-007 | AI 建议池（建议生成、采纳、忽略、执行） | V2 | PG0069 | 来自分析页/对话生成建议；列表页操作采纳/忽略/执行 | M10 AIInsight/AIAction；引用：M02/M03/M08 等对象；审计：AuditLog | 建议标题；优先级；原因摘要；证据数据点；建议动作按钮；处理状态 | 创建招聘需求(M03)；创建工单(M08)；发起异动流程(M02) | 仅允许拥有下游动作权限的用户点击‘执行’；否则仅可查看/转交（可选） | 下游对象变更导致建议过期→提示‘已过期’并要求重新生成；重复执行需幂等 |
| AI-SC-008 | AI 输出留痕与可解释性审计 | V2 | PG0070 | 留痕列表查看/导出/回溯 | AIAudit/AIInsight/AIAction；AuditLog；引用对象快照（可选） | 列表；详情抽屉：输入摘要/引用数据/输出/采纳情况/导出 | 标记问题样本；导出审计报告 | 仅审计角色可见；导出遵循字段权限；对话内容可脱敏存储（可配置） | 引用数据已被删除/权限变更→显示‘引用不可用’并保留当时快照（可选） |
| AI-SC-009 | AI 离职风险识别（解释型、非自动决策） | V3 | PG0071 | 点击生成/刷新；或计划任务（可选） | M02 EmploymentEvent/Employee/合同/调薪；M07 绩效结果；M05 考勤异常(可选)；M08 工单/满意度(可选) | 风险摘要；风险员工列表（脱敏/最小必要）；原因解释；建议跟进动作；误报反馈入口 | 创建跟进工单(M08)；生成面谈清单（导出）；标记误报 | 经理只能看自己团队且不展示敏感原因细节；小样本保护；禁止输出推断性敏感结论 | 数据缺失→降低置信度并提示补齐字段；样本不足→仅给团队级风险不下沉到个人 |
| AI-SC-010 | AI What-if 模拟（不招聘/组织调整/编制变更影响） | V3 | PG0072 | 配置参数→运行模拟→保存方案/导出 | M02 编制/在岗；M03 在招需求；M10 风险基线（AI-SC-009） | 方案摘要；参数表；影响对比表；风险变化；建议下一步动作 | 保存方案；导出；（可选）一键发起招聘/调岗/调编流程 | 仅具备相应管理权限者可保存/执行；导出遵循字段权限 | 参数不合法→提示修正；基线数据缺失→提示先生成基线分析 |
| AI-SC-011 | AI 薪资变动解释（工资条解释助手） | V2 | PG0066 | 对话输入（如‘为什么我本月工资少了？’）或工资条页入口（若有） | M06 Payslip/PayrollRun；M05 考勤汇总；（可选）M02 调薪事件 | 结论摘要；差异Top列表；原因解释；口径提示；如有疑问引导提工单 | 创建工单（薪资疑问）（M08） | 员工仅本人；敏感项目按字段权限控制；不输出其他员工对比 | 无工资条→提示等待发放/联系HR；考勤未封账→提示数据可能变化 |
| AI-SC-012 | AI 绩效评语/总结辅助（不生成最终评分） | V2 | PG0066 | 对话输入或绩效页入口（若接入） | M07 Goal/Review；（可选）M08 工单/奖惩记录（若启用） | 评语草稿；亮点/不足；下期建议；面谈提纲；需用户确认的事实清单 | 复制到绩效评估表（手动粘贴或按钮可选） | 仅可见范围；禁止提及敏感个人信息；输出提示‘需人工审核’ | 缺少目标/记录→提示补齐；用户输入与系统记录冲突→提示以系统为准 |
