# HR AI SaaS 微服务架构设计

> **版本**: v1.0.0
>
> **创建日期**: 2026-02-02
>
> **文档状态**: 初稿

---

## 一、架构设计目标

### 1.1 核心目标

| 目标 | 描述 |
|------|------|
| **清晰** | 架构层次分明，职责边界清晰，易于理解 |
| **可扩展** | 支持水平扩展、模块扩展、功能扩展 |
| **易于维护** | 独立部署、独立测试、故障隔离 |
| **解耦** | 模块间低依赖，通过标准接口通信 |
| **演进** | 预留扩展点，支持平滑升级到A2A/服务网格 |

### 1.2 架构原则

1. **单一职责原则**：每个服务专注于单一业务域
2. **松耦合原则**：服务间通过标准接口通信，不共享内部实现
3. **高内聚原则**：相关功能集中在同一服务内
4. **边界清晰原则**：数据存储、服务边界明确
5. **演进友好原则**：关键决策预留扩展点

---

## 二、整体架构图

### 2.1 架构分层

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          接入层 (Gateway Layer)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  API网关    │  │  负载均衡   │  │  鉴权校验   │  │  限流熔断   │    │
│  │  Spring    │  │   Nginx     │  │  (网关)    │  │   Sentinel  │    │
│  │  Cloud     │  │   / Envoy   │  │  + JWK     │  │   / Resilience4j │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          服务层 (Service Layer)                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                    业务微服务 (按域拆分)                              ││
│  ├─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┤│
│  │ hr-org  │ hr-core │hr-recruit│hr-attend│hr-payroll│hr-perf │hr-ticket││
│  │ (M01)   │ (M02)   │  (M03)  │  (M05)  │  (M06)  │  (M07)  │  (M08)  ││
│  └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘│
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                      平台能力服务                                     ││
│  ├─────────────┬─────────────┬─────────────┬─────────────┬─────────────┤│
│  │  hr-ai      │ hr-rag      │ hr-gateway  │ hr-admin    │ hr-report   ││
│  │  (M10)      │  (RAG)      │ (API网关)   │ (管理后台)  │  (M09)      ││
│  └─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘│
└─────────────────────────────────────────────────────────────────────────┘

> 说明：认证采用 JWT，网关统一验签与基础鉴权，业务服务做细粒度授权。
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐
│    数据层         │  │    消息层         │  │    智能层         │
│  ┌───────────┐   │  │  ┌───────────┐   │  │  ┌───────────┐   │
│  │  MySQL    │   │  │  │  Kafka    │   │  │  │  Milvus   │   │
│  │ (8.0 主库)│   │  │  │ (消息队列) │   │  │  │ (向量库)  │   │
│  └───────────┘   │  │  └───────────┘   │  │  └───────────┘   │
│  ┌───────────┐   │  │                  │  │                  │
│  │  Redis    │   │  │                  │  │                  │
│  │ (缓存)    │   │  │                  │  │                  │
│  └───────────┘   │  │                  │  │                  │
└───────────────────┘  └───────────────────┘  └───────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        基础设施层 (Infrastructure)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   Nacos     │  │   SkyWalking│  │    ELK      │  │   Docker    │    │
│  │  (配置/注册) │  │  (链路追踪) │  │  (日志聚合) │  │  (容器化)   │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 服务拆分概览

| 服务名称 | 模块 | 端口 | 数据源 | 描述 |
|----------|------|------|--------|------|
| **hr-org-service** | M01 | 8081 | mysql-hr-org | 组织与权限管理 |
| **hr-core-service** | M02 | 8082 | mysql-hr-core | Core HR管理 |
| **hr-recruit-service** | M03/M04 | 8083 | mysql-hr-recruit | 招聘与入职管理 |
| **hr-attend-service** | M05 | 8084 | mysql-hr-attend | 考勤假勤管理 |
| **hr-payroll-service** | M06 | 8085 | mysql-hr-payroll | 薪酬薪资管理 |
| **hr-perf-service** | M07 | 8086 | mysql-hr-perf | 绩效管理 |
| **hr-ticket-service** | M08 | 8087 | mysql-hr-ticket | 工单与知识库 |
| **hr-report-service** | M09 | 8088 | mysql-hr-report | 报表与分析 |
| **hr-ai-service** | M10 | 8089 | mysql-hr-ai | AI能力中心 |
| **hr-rag-service** | RAG | 8090 | mysql-hr-rag + Milvus | RAG检索服务 |
| **hr-gateway** | GW | 8080 | - | API网关 |

> 说明：M03/M04 当前合并为 **hr-recruit-service**（招聘与入职），后续若拆分需保持 API 契约与数据边界稳定。  
> 说明：认证采用 JWT，登录与签发由 hr-org-service 提供，网关统一验签，业务服务做细粒度授权。

---

## 三、微服务拆分方案

### 3.1 拆分原则

1. **业务域驱动**：按业务能力（Business Capability）划分
2. **数据自治**：每个服务拥有独立的数据源
3. **边界稳定**：选择相对稳定的业务边界
4. **团队组织**：考虑团队协作模式
5. **演进路径**：支持从单体平滑演进到微服务

### 3.2 服务详细拆分

#### 3.2.1 hr-org-service (组织与权限服务)

**职责**：
- 组织架构管理（公司、部门、团队）
- 用户与账号管理（含登录与 JWT 签发）
- 角色与权限管理
- 审计日志

**API接口**：
```yaml
/base:
  /org/units:
    GET    - 获取组织树
    POST   - 创建组织
    PUT    - 更新组织
    DELETE - 删除组织
  /users:
    GET    - 用户列表
    POST   - 创建用户
    PUT    - 更新用户
    DELETE - 删除用户
  /roles:
    GET    - 角色列表
    POST   - 创建角色
    PUT    - 更新角色
  /permissions:
    GET    - 权限列表
    PUT    - 分配权限
  /audit-logs:
    GET    - 审计日志表**：
- `org_units`
-
```

**数据 `sys_users`
- `sys_roles`
- `sys_user_roles`
- `sys_role_permissions`
- `audit_logs`

---

#### 3.2.2 hr-core-service (Core HR服务)

**职责**：
- 岗位管理
- 编制管理
- 员工档案管理
- 人事事件处理（入职、转正、调岗、调薪、离职）

**API接口**：
```yaml
/hr:
  /positions:
    CRUD - 岗位管理
  /headcounts:
    CRUD - 编制管理
    GET  - 编制汇总
  /employees:
    GET  - 员工列表/花名册
    POST - 创建员工
    PUT  - 更新员工
    GET  - 员工详情
  /employment-events:
    GET  - 事件列表
    POST - 创建事件
    PUT  - 审批事件
```

**数据表**：
- `positions`
- `headcounts`
- `employees`
- `employee_details`
- `employment_events`

**状态机**：
- `EmploymentEventStateMachine`（draft → pending → approved/rejected → effective）

---

#### 3.2.3 hr-recruit-service (招聘入职服务)

**职责**：
- 招聘需求管理
- 候选人管理
- 面试管理
- Offer管理
- 入职流程管理

**API接口**：
```yaml
/recruiting:
  /requisitions:
    CRUD - 招聘需求
    POST - 提交审批
  /candidates:
    CRUD - 候选人
    POST - AI简历解析
  /interviews:
    CRUD - 面试安排
    POST - 面试反馈
  /offers:
    CRUD - Offer管理
    PUT  - 候选人反馈

/onboarding:
  /processes:
    CRUD - 入职流程
    PUT  - 资料收集
    PUT  - 入职完成
  /materials:
    CRUD - 入职资料
```

**数据表**：
- `job_requisitions`
- `candidates`
- `candidate_resumes`
- `candidate_applications`
- `interviews`
- `interview_feedbacks`
- `offers`
- `onboardings`
- `onboarding_materials`

**状态机**：
- `JobRequisitionStateMachine`
- `CandidateStateMachine`

---

#### 3.2.4 hr-attend-service (考勤假勤服务)

**职责**：
- 班次配置
- 考勤规则管理
- 打卡记录管理
- 请假管理
- 加班管理

**API接口**：
```yaml
/attendance:
  /shifts:
    CRUD - 班次管理
  /rules:
    CRUD - 考勤规则
  /records:
    GET  - 打卡记录
    POST - 补卡申请
  /leaves:
    GET  - 请假列表
    POST - 申请请假
    PUT  - 审批请假
  /overtimes:
    GET  - 加班列表
    POST - 申请加班
    PUT  - 审批加班
```

**数据表**：
- `attendance_shifts`
- `attendance_rules`
- `attendance_records`
- `leave_types`
- `leave_balances`
- `leave_requests`
- `overtime_requests`

**状态机**：
- `LeaveRequestStateMachine`
- `OvertimeRequestStateMachine`

---

#### 3.2.5 hr-payroll-service (薪酬薪资服务)

**职责**：
- 薪酬项目配置
- 员工薪资档案
- 算薪批次管理
- 工资条管理

**API接口**：
```yaml
/payroll:
  /items:
    CRUD - 薪酬项目
  /archives:
    CRUD - 薪资档案
    PUT  - 调薪记录
  /runs:
    GET  - 算薪批次
    POST - 发起算薪
    PUT  - 计算/复核/审批/发放
  /details:
    GET  - 薪资明细
  /payslips:
    GET  - 工资条
    PUT  - 确认/查看
```

**数据表**：
- `salary_items`
- `salary_archives`
- `payroll_runs`
- `payroll_details`
- `payslips`

**状态机**：
- `PayrollRunStateMachine`（draft → calculating → reviewing → approved → paid）

---

#### 3.2.6 hr-perf-service (绩效管理服务)

**职责**：
- 绩效周期管理
- 目标设定与跟踪
- 绩效评估
- 绩效校准与结果

**API接口**：
```yaml
/performance:
  /cycles:
    CRUD - 绩效周期
    POST - 启动各阶段
  /goals:
    CRUD - 绩效目标
    PUT  - 目标审批
  /reviews:
    GET  - 评估列表
    POST - 提交评估
    PUT  - AI评语生成
  /results:
    GET  - 绩效结果
    PUT  - 校准/确认
```

**数据表**：
- `performance_cycles`
- `performance_goals`
- `performance_reviews`
- `performance_results`

**状态机**：
- `PerformanceCycleStateMachine`

---

#### 3.2.7 hr-ticket-service (工单知识库服务)

**职责**：
- 工单类型管理
- 工单处理
- 知识库管理
- AI工单路由

**API接口**：
```yaml
/ticket:
  /types:
    CRUD - 工单类型
  /tickets:
    GET  - 工单列表
    POST - 提交工单
    PUT  - 处理工单
    PUT  - AI路由分配
  /comments:
    CRUD - 工单评论
  /knowledge:
    CRUD - 知识库文章
    GET  - 搜索文章
```

**数据表**：
- `ticket_types`
- `tickets`
- `ticket_comments`
- `knowledge_articles`

**状态机**：
- `TicketStateMachine`（new → assigned → in_progress → resolved → closed）

---

#### 3.2.8 hr-report-service (报表分析服务)

**职责**：
- 考勤汇总报表
- 薪资汇总报表
- 分析看板
- 自定义报表

**API接口**：
```yaml
/reports:
  /attendance:
    GET  - 考勤汇总
  /payroll:
    GET  - 薪资汇总
  /dashboards:
    GET  - 分析看板
  /custom:
    POST - 自定义报表
    GET  - 报表列表
```

**数据表**：
- `report_configs`
- `report_templates`
- `report_executions`

---

#### 3.2.9 hr-ai-service (AI能力中心)

**职责**：
- AI对话管理
- AI洞察生成
- AI建议生成
- AI审计日志
- What-if模拟
- 对接 hr-rag-service，提供检索增强上下文（RAG）

**API接口**：
```yaml
/ai:
  /chat:
    POST - AI对话
    GET  - 对话历史
  /insights:
    GET  - 团队洞察
    GET  - 离职风险
    GET  - 组织健康度
  /suggestions:
    GET  - AI建议列表
    PUT  - 执行/忽略建议
  /audit:
    GET  - 审计日志
  /whatif:
    POST - What-if模拟
    GET  - 模拟结果
```

**数据表**：
- `ai_conversations`
- `ai_sessions`
- `ai_suggestions`
- `ai_audit_logs`
- `ai_whatif_scenarios`

**AI场景**：
- `AI-SC-001` ~ `AI-SC-012`

**技术实现依赖（AI能力中心）**：
- Spring AI Alibaba 1.1.0.0-RC2
- 基础依赖使用 `spring-ai-alibaba-agent-framework`（替换 `spring-ai-alibaba-starter` + `spring-ai-alibaba-starter-agent`）
- 图编排能力由 `spring-ai-alibaba-graph-core` 提供（由 agent-framework 传递依赖；如需直接调用 Graph API 可显式引入）
- MCP/A2A 使用 `spring-ai-alibaba-starter-nacos-mcp-server` 与 `spring-ai-alibaba-starter-a2a-*`

---

#### 3.2.10 hr-rag-service (RAG检索服务)

**职责**：
- 知识库管理
- 向量索引管理
- RAG检索
- 文档解析
- 对内服务：默认仅供 hr-ai-service 调用

**API接口**：
```yaml
/rag:
  /knowledge:
    POST - 上传文档
    GET  - 文档列表
    DELETE - 删除文档
  /chunks:
    GET  - 知识块列表
    PUT  - 更新知识块
  /search:
    POST - 向量检索
    GET  - 混合检索
  /index:
    POST - 重建索引
```

**数据存储**：
- MySQL: `knowledge_docs`, `knowledge_chunks`
- Milvus: `hr_knowledge` collection

---

## 四、服务通信与治理

### 4.1 服务注册与发现

```
┌─────────────────────────────────────────────────────────────┐
│                      Nacos Server                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   服务注册中心                       │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │hr-org    │ │hr-core   │ │hr-recruit│ ...        │   │
│  │  │8081     │ │8082     │ │8083     │            │   │
│  │  │UP       │ │UP       │ │UP       │            │   │
│  │  └──────────┘ └──────────┘ └──────────┘            │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   配置中心                           │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │hr-org    │ │hr-core   │ │hr-recruit│ ...        │   │
│  │  │dev/prod  │ │dev/prod  │ │dev/prod  │            │   │
│  │  └──────────┘ └──────────┘ └──────────┘            │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**配置示例**：

```yaml
# application.yml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: HRAI_GROUP
      config:
        server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: HRAI_GROUP
        file-extension: yaml

# 服务元数据
spring.cloud.nacos.discovery.metadata:
  service.type: business
  service.version: 1.0.0
  service.env: ${SPRING_PROFILES_ACTIVE:dev}
```

**网关注册要求**：
- 统一网关 `hr-gateway` 必须注册到 Nacos，作为统一入口。
- 路由规则建议通过 Nacos Config 下发与版本化管理。

**网关注册示例**：
```yaml
spring:
  application:
    name: hr-gateway
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER_ADDR:localhost:8848}
        group: HRAI_GROUP
```

### 4.2 服务通信模式

#### 4.2.1 同步通信（RESTful）

**使用场景**：
- 需要即时响应的请求
- 简单查询操作
- 短流程调用

**Feign客户端定义**：

```java
@FeignClient(name = "hr-org-service", path = "/api/org")
public interface OrgClient {
    
    @GetMapping("/units/tree")
    Result<OrgTreeDTO> getOrgTree(@RequestParam("tenantId") String tenantId);
    
    @GetMapping("/users/{id}")
    Result<UserDTO> getUserById(@PathVariable("id") Long id);
    
    @PostMapping("/audit-logs")
    Result<Void> createAuditLog(@RequestBody AuditLogCreateDTO dto);
}
```

#### 4.2.2 异步通信（Kafka）

**使用场景**：
- 跨模块事件通知
- 耗时较长的处理
- A2A任务委派

**事件模型**：

```java
// 领域事件基类
public abstract class DomainEvent {
    private String eventId;
    private String eventType;
    private String tenantId;
    private Long userId;
    private LocalDateTime timestamp;
    private Map<String, Object> payload;
}

// 具体事件示例
public class OfferAcceptedEvent extends DomainEvent {
    private Long offerId;
    private Long candidateId;
    private Long positionId;
    private Long orgUnitId;
}

// Kafka Topic配置
public interface EventTopics {
    String EMPLOYMENT_EVENT = "employment-event";
    String OFFER_EVENT = "offer-event";
    String ONBOARDING_EVENT = "onboarding-event";
    String AI_TASK = "ai-task";
    String A2A_DELEGATION = "a2a-delegation";
}

// 事件发布
@Component
public class EventPublisher {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    public void publishOfferAccepted(OfferAcceptedEvent event) {
        kafkaTemplate.send(
            EventTopics.OFFER_EVENT,
            event.getTenantId(),
            event
        );
    }
}
```

### 4.3 A2A协议预留

```
┌─────────────────────────────────────────────────────────────────────┐
│                      A2A (API-to-API) 架构预留                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐      A2A Protocol      ┌─────────────┐            │
│  │ Service A   │ ◄───────────────────► │ Service B   │            │
│  │             │  TaskRequest/Response │             │            │
│  │  Agent A    │                       │  Agent B    │            │
│  └──────┬──────┘                       └──────┬──────┘            │
│         │                                      │                   │
│         └──────────┬───────────────────────────┘                   │
│                    ▼                                                │
│         ┌─────────────────────┐                                     │
│         │   Nacos A2A Registry│  (A2A Agent Discovery)             │
│         │                     │                                     │
│         │  - Agent Metadata   │                                     │
│         │  - Capability List  │                                     │
│         │  - Task Handlers    │                                     │
│         └─────────────────────┘                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**A2A接口定义（预留）**：

```yaml
/a2a:
  /agents:
    GET    - 获取可用Agent列表
    POST   - 注册Agent
  /tasks:
    POST   - 提交任务 (A2A TaskRequest)
    GET    - 查询任务状态
    DELETE - 取消任务
  /messages:
    GET    - 获取任务消息历史
```

### 4.4 服务治理策略

#### 4.4.1 负载均衡

```yaml
spring:
  cloud:
    loadbalancer:
      nacos:
        enabled: true
      # 配置重试策略
      retry:
        max-retries-on-same-service-instance: 1
        max-retries-on-next-service-instance: 2
        retry-on-all-operations: true
```

#### 4.4.2 熔断降级

```java
@Configuration
public class ResilienceConfig {
    
    @Bean
    public CircuitBreakerRegistry circuitBreakerRegistry() {
        CircuitBreakerConfig config = CircuitBreakerConfig.custom()
            .failureRateThreshold(50)
            .slowCallRateThreshold(80)
            .slowCallDurationThreshold(Duration.ofSeconds(2))
            .waitDurationInOpenState(Duration.ofSeconds(30))
            .permittedNumberOfCallsInHalfOpenState(5)
            .slidingWindowType(CircuitBreakerConfig.SlidingWindowType.COUNT_BASED)
            .slidingWindowSize(10)
            .build();
        
        return CircuitBreakerRegistry.of(config);
    }
}

// 熔断降级示例
@FeignClient(name = "hr-org-service")
public interface OrgClient {
    
    @CircuitBreaker(name = "orgService", fallbackMethod = "getOrgTreeFallback")
    @GetMapping("/org/units/tree")
    Result<OrgTreeDTO> getOrgTree(@RequestParam("tenantId") String tenantId);
    
    default Result<OrgTreeDTO> getOrgTreeFallback(String tenantId, Throwable t) {
        log.warn("org-service 调用失败，使用缓存数据: {}", t.getMessage());
        return Result.success(getCachedOrgTree(tenantId));
    }
}
```

#### 4.4.3 限流

```java
@Configuration
public class RateLimitConfig {
    
    @Bean
    public RateLimiter userServiceLimiter() {
        return RateLimiter.builder()
            .name("user-service")
            .limitForPeriod(100)  // 每个时间窗口的请求数
            .limitRefreshPeriod(Duration.ofSeconds(1))  // 时间窗口
            .timeoutDuration(Duration.ofMillis(500))
            .build();
    }
}

// 使用Sentinel限流
@RestController
@RequestMapping("/api/hr/employees")
public class EmployeeController {
    
    @Autowired
    private RateLimiter employeeListLimiter;
    
    @GetMapping
    @SentinelResource(value = "employeeList", blockHandler = "employeeListBlock")
    public Result<List<EmployeeDTO>> listEmployees(
            @RequestParam String tenantId,
            EmployeeQueryDTO query) {
        return employeeService.listEmployees(tenantId, query);
    }
    
    public Result<List<EmployeeDTO>> employeeListBlock(
            String tenantId, EmployeeQueryDTO query, BlockException ex) {
        return Result.error("系统繁忙，请稍后再试");
    }
}
```

### 4.5 多租户与数据隔离（JWT + 数据源路由）

**原则**：
- 认证采用 JWT，登录与签发由 hr-org-service 提供，网关统一验签与基础鉴权，服务内二次授权。
- 业务请求优先从 JWT 解析租户；必要时透传 `X-Tenant-Id`（仅内网调用）。
- 数据隔离优先“租户独立库”，兼容同库隔离（schema/tenant_id 分区）。

**租户注册表（示例）**：
- 归属：hr-org-service（或独立配置库）
- 规划落地：配置库维护 `tenant_registry`（待实现）
- 表：`tenant_registry(tenant_id, db_url, db_user, db_password_cipher, status, created_at)`

**数据源路由（示例伪码）**：
```java
public final class TenantContext {
    private static final ThreadLocal<String> TENANT = new ThreadLocal<>();
    public static void set(String tenantId) { TENANT.set(tenantId); }
    public static String get() { return TENANT.get(); }
    public static void clear() { TENANT.remove(); }
}

public class TenantRoutingDataSource extends AbstractRoutingDataSource {
    @Override
    protected Object determineCurrentLookupKey() {
        return TenantContext.get();
    }
}
```

**JWT 载荷示例**：
```json
{ "tenant_id": "t-001", "user_id": 1001, "roles": ["HR_ADMIN"] }
```

---

## 五、配置管理与CI/CD

### 5.1 配置管理策略

```
┌─────────────────────────────────────────────────────────────┐
│                    Nacos 配置管理层次                         │
├─────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Shared Configs (共享配置)                  │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐         │   │
│  │  │ common.yml   │ │ db.yml       │ │ redis.yml    │         │   │
│  │  │ (公共配置)   │ │ (数据源)     │ │ (缓存配置)   │         │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Service Configs (服务配置)                 │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐         │   │
│  │  │ hr-org.yml   │ │ hr-core.yml  │ │ hr-ai.yml    │         │   │
│  │  │ (服务私有)   │ │ (服务私有)   │ │ (AI配置)     │         │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Profile Configs (环境配置)                 │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐         │   │
│  │  │ application- │ │ application- │ │ application- │         │   │
│  │  │ dev.yml      │ │ test.yml     │ │ prod.yml     │         │   │
│  │  │ (开发环境)   │ │ (测试环境)   │ │ (生产环境)   │         │   │
│  │  └──────────────┘ └──────────────┘ └──────────────┘         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────┘
```

**配置文件模板**：

```yaml
# hr-org-service.yml (Nacos配置)
spring:
  datasource:
    url: jdbc:mysql://${mysql.host:localhost}:${mysql.port:3306}/${mysql.database:hr_org}?useSSL=false
    username: ${mysql.username:root}
    password: ${mysql.password:hr_ai_2025}
    driver-class-name: com.mysql.cj.jdbc.Driver
    
  redis:
    host: ${redis.host:localhost}
    port: ${redis.port:6379}
    database: ${redis.database:1}

# 服务特有配置
service:
  name: hr-org-service
  version: 1.0.0
  
# 业务配置
org:
  tree:
    max-depth: 10
    cache-ttl: 3600
  user:
    password:
      bcrypt-strength: 10
```

### 5.2 CI/CD 流程设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           CI/CD 流程图                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐          │
│  │  Code   │────►│  Build  │────►│  Test   │────►│  Image  │          │
│  │  Commit │     │  Maven  │     │  JUnit  │     │  Build  │          │
│  └─────────┘     └─────────┘     └─────────┘     └────┬────┘          │
│                                                       │                │
│                                                       ▼                │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐          │
│  │  Prod   │◄────│ Deploy  │◄────│ Staging │◄────│  Push   │          │
│  │  (K8s)  │     │  Helm   │     │  (K8s)  │     │ Registry│          │
│  └─────────┘     └─────────┘     └─────────┘     └─────────┘          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**GitLab CI配置示例**：

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - package
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  DOCKER_REGISTRY: registry.example.com

build:
  stage: build
  script:
    - mvn clean compile -DskipTests
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .m2/repository

test:
  stage: test
  script:
    - mvn test
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      junit: target/surefire-reports/*.xml
      coverage_report:
        coverage_format: cobertura
        path: target/site/cobertura/coverage.xml

package:
  stage: package
  script:
    - mvn package -DskipTests
    - docker build -t $DOCKER_REGISTRY/hr-ai:$CI_COMMIT_SHA .
    - docker push $DOCKER_REGISTRY/hr-ai:$CI_COMMIT_SHA
  only:
    - main
    - develop

deploy_dev:
  stage: deploy
  script:
    - helm upgrade --install hr-org ./helm/hr-org \
      --set image.repository=$DOCKER_REGISTRY/hr-org \
      --set image.tag=$CI_COMMIT_SHA \
      --set environment=dev
  environment:
    name: dev
  only:
    - develop

deploy_staging:
  stage: deploy
  script:
    - helm upgrade --install hr-org ./helm/hr-org \
      --set image.repository=$DOCKER_REGISTRY/hr-org \
      --set image.tag=$CI_COMMIT_SHA \
      --set environment=staging
  environment:
    name: staging
  when: manual
  only:
    - main

deploy_prod:
  stage: deploy
  script:
    - helm upgrade --install hr-org ./helm/hr-org \
      --set image.repository=$DOCKER_REGISTRY/hr-org \
      --set image.tag=$CI_COMMIT_SHA \
      --set environment=prod
  environment:
    name: prod
  when: manual
  only:
    - tags
```

### 5.3 Docker Compose 编排

```yaml
# docker-compose.yml (开发环境)
version: '3.8'

services:
  # MySQL 主库集群
  mysql-org:
    image: mysql:8.0
    container_name: hr-mysql-org
    environment:
      MYSQL_ROOT_PASSWORD: hr_ai_2025
    volumes:
      - mysql-org-data:/var/lib/mysql
      - ./db/hr-org-schema.sql:/docker-entrypoint-initdb.d/schema.sql
    ports:
      - "3307:3306"
    networks:
      - hrai-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql-core:
    image: mysql:8.0
    container_name: hr-mysql-core
    environment:
      MYSQL_ROOT_PASSWORD: hr_ai_2025
    volumes:
      - mysql-core-data:/var/lib/mysql
    ports:
      - "3308:3306"
    networks:
      - hrai-network

  # Redis 集群
  redis:
    image: redis:7-alpine
    container_name: hr-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - hrai-network
    command: redis-server --appendonly yes

  # Nacos
  nacos:
    image: nacos/nacos-server:v2.3.2
    container_name: hr-nacos
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: mysql
      MYSQL_SERVICE_DB_NAME: nacos_config
      MYSQL_SERVICE_PORT: 3306
    ports:
      - "8848:8848"
    volumes:
      - nacos-data:/home/nacos/data
    networks:
      - hrai-network

  # Kafka
  kafka:
    image: bitnami/kafka:3.6
    container_name: hr-kafka
    environment:
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
    ports:
      - "9092:9092"
    volumes:
      - kafka-data:/bitnami
    networks:
      - hrai-network

  # Milvus
  milvus:
    image: milvusdb/milvus:v2.5.4
    container_name: hr-milvus
    ports:
      - "19530:19530"
      - "8000:8000"
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - hrai-network
    depends_on:
      - etcd
      - minio

  # 服务网关
  hr-gateway:
    build: ./services/hr-gateway
    container_name: hr-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: dev
    networks:
      - hrai-network
    depends_on:
      - nacos

volumes:
  mysql-org-data:
  mysql-core-data:
  redis-data:
  nacos-data:
  kafka-data:
  milvus-data:

networks:
  hrai-network:
    driver: bridge
```

### 5.4 Kubernetes Helm 部署

```yaml
# helm/hr-org/values.yaml
replicaCount: 2

image:
  repository: registry.example.com/hr-org
  tag: latest
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 8081

ingress:
  enabled: true
  className: nginx
  annotations:
    kubernetes.io/tls-acme: "true"
  hosts:
    - host: hr-org.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: hr-org-tls
      hosts:
        - hr-org.example.com

resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70

configMap:
  SPRING_PROFILES_ACTIVE: prod
  NACOS_SERVER_ADDR: nacos.hrai.svc.cluster.local:8848
  MYSQL_HOST: mysql.hrai.svc.cluster.local

secrets:
  mysql:
    existingSecret: mysql-credentials
  nacos:
    existingSecret: nacos-credentials

livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: 8081
  initialDelaySeconds: 60
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: 8081
  initialDelaySeconds: 30
  periodSeconds: 10
```

---

## 六、监控、日志与容错

### 6.1 监控体系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           监控架构                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      应用层监控 (Micrometer)                       │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │ JVM指标  │ │ HTTP请求 │ │ 数据库   │ │ 业务指标 │            │   │
│  │  │ (内存)   │ │ (QPS)   │ │ (连接)   │ │ (订单量) │            │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      链路追踪 (SkyWalking)                        │   │
│  │                                                                  │   │
│  │   Service A ────► Trace ID ────► Service B ────► Trace ID ...   │   │
│  │        │                  │                  │                  │   │
│  │        ▼                  ▼                  ▼                  │   │
│  │   Span Data          Span Data          Span Data              │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      可视化平台 (Grafana)                         │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │ 仪表盘   │ │ 告警规则 │ │ 日志查询 │ │ 链路追踪 │            │   │
│  │  │ Dashboards│ │ Alerts   │ │  Logs    │ │ Traces   │            │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**监控指标定义**：

```java
@Configuration
public class MetricsConfig {
    
    @Bean
    public MeterRegistry meterRegistry() {
        return new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);
    }
}

@RestController
@RequestMapping("/api/hr/employees")
public class EmployeeController {
    
    private final Counter employeeListCounter;
    private final Timer employeeListTimer;
    
    public EmployeeController(MeterRegistry registry) {
        this.employeeListCounter = Counter.builder("hr.employee.list.count")
            .description("员工列表查询次数")
            .tag("service", "hr-employee")
            .register(registry);
        
        this.employeeListTimer = Timer.builder("hr.employee.list.time")
            .description("员工列表查询耗时")
            .tag("service", "hr-employee")
            .register(registry);
    }
    
    @GetMapping
    public Result<List<EmployeeDTO>> listEmployees(
            @RequestParam String tenantId,
            EmployeeQueryDTO query) {
        
        return employeeListTimer.record(() -> {
            employeeListCounter.increment();
            return employeeService.listEmployees(tenantId, query);
        });
    }
}
```

### 6.2 日志聚合

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           日志架构                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      应用日志 (Logback)                           │   │
│  │                                                                  │   │
│  │  [%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level]             │   │
│  │  [%logger{36}] [%X{traceId}] - %msg%n                           │   │
│  │                                                                  │   │
│  │  关键字段: traceId, spanId, tenantId, userId                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼ (Filebeat/Fluentd)                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      日志收集 (Logstash)                          │   │
│  │                                                                  │   │
│  │  Input: Filebeat ──► Filter: Grok ──► Output: ES                 │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      存储与查询 (Elasticsearch)                   │   │
│  │                                                                  │   │
│  │  Index Pattern: logstash-hr-ai-*                                 │   │
│  │  Index Lifecycle: hot(7d) → warm(30d) → delete(90d)             │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**日志配置**：

```xml
<!-- logback-spring.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <property name="LOG_PATTERN" 
        value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} [%X{traceId:-}] - %msg%n"/>
    
    <!-- Console Appender -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>
    
    <!-- JSON File Appender (for log aggregation) -->
    <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/hr-org-service.json</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/hr-org-service.%d{yyyy-MM-dd}.json</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"service":"hr-org-service","environment":"${SPRING_PROFILES_ACTIVE}"}</customFields>
            <includeMdcKeyName>traceId,spanId,tenantId,userId</includeMdcKeyName>
        </encoder>
    </appender>
    
    <!-- Async Appender -->
    <appender name="ASYNC_JSON" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="JSON_FILE"/>
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
    </appender>
    
    <!-- Logger Config -->
    <logger name="com.hrai" level="INFO" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ASYNC_JSON"/>
    </logger>
    
    <logger name="org.springframework" level="WARN"/>
    <logger name="org.mybatis" level="INFO"/>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ASYNC_JSON"/>
    </root>
</configuration>
```

### 6.3 容错与高可用

```java
// 全局异常处理
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BizException.class)
    public Result<Void> handleBizException(BizException ex) {
        log.error("业务异常: {}", ex.getMessage(), ex);
        return Result.error(ex.getCode(), ex.getMessage());
    }
    
    @ExceptionHandler(FeignException.class)
    public Result<Void> handleFeignException(FeignException ex) {
        log.error("服务调用异常: {}", ex.getMessage(), ex);
        return Result.error("服务暂时不可用，请稍后重试");
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception ex) {
        log.error("系统异常: {}", ex.getMessage(), ex);
        return Result.error("系统异常，请联系管理员");
    }
}

// 断路器配置
@Configuration
public class CircuitBreakerConfig {
    
    @Bean
    public SecuritySignalRegistry signalRegistry() {
        // 配置熔断器信号量
        return SecuritySignalRegistryBuilder.create()
            .withCircuitBreaker("default", CircuitBreakerConfig.ofDefaults())
            .withBulkhead("default", BulkheadConfig.ofDefaults())
            .build();
    }
}
```

---

## 七、演进路线图

### 7.1 阶段规划

| 阶段 | 时间范围 | 目标 | 交付物 |
|------|----------|------|--------|
| **Phase 1** | 当前 | 单体应用优化 | 完善现有模块 |
| **Phase 2** | 1-2月 | 模块拆分准备 | 服务边界定义、API契约 |
| **Phase 3** | 2-4月 | 核心服务拆分 | hr-org, hr-core, hr-recruit |
| **Phase 4** | 4-6月 | 全部服务拆分 | 全部10个微服务 |
| **Phase 5** | 6月+ | 架构演进 | A2A集成、服务网格 |

### 7.2 迁移策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         单体到微服务迁移策略                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 绞杀者模式 (Strangler Pattern)                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                  │   │
│  │     Monolith ◄── Proxy/API Gateway ──► New Microservice         │   │
│  │         │                          │                             │   │
│  │         │                          ▼                             │   │
│  │         │                    ┌─────────────┐                    │   │
│  │         └───────────────────►│  逐步迁移   │                    │   │
│  │                           │  功能模块    │                    │   │
│  │                           └─────────────┘                    │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  2. 迁移顺序 (按业务优先级)                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                  │   │
│  │  Step 1: hr-org (组织权限) - 低风险、高频使用                    │   │
│  │      ↓                                                           │   │
│  │  Step 2: hr-core (Core HR) - 核心业务                           │   │
│  │      ↓                                                           │   │
│  │  Step 3: hr-recruit (招聘入职) - 中等复杂度                      │   │
│  │      ↓                                                           │   │
│  │  Step 4: hr-attend, hr-payroll (考勤薪酬) - 数据密集型           │   │
│  │      ↓                                                           │   │
│  │  Step 5: hr-perf, hr-ticket (绩效工单) - 业务复杂型              │   │
│  │      ↓                                                           │   │
│  │  Step 6: hr-report, hr-ai, hr-rag (报表AI) - 能力型服务          │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.3 A2A演进准备

```yaml
# A2A 能力预留设计

# 1. Agent 能力注册
a2a:
  agents:
    - name: "hr-policy-agent"
      description: "HR政策专家Agent"
      capabilities:
        - "hr-policy-query"
        - "leave-policy-explain"
        - "salary-policy-query"
      endpoints:
        task: "/a2a/tasks"
        messages: "/a2a/messages"
    
    - name: "recruiting-agent"
      description: "招聘助手Agent"
      capabilities:
        - "resume-parsing"
        - "candidate-matching"
        - "interview-scheduling"

# 2. 任务委派协议
protocol:
  a2a:
    version: "1.0"
    task-ttl: "24h"
    message-ttl: "72h"
    ack-timeout: "30s"

# 3. 服务网格准备
service-mesh:
  istio:
    enabled: true
    traffic-management:
      - virtual-services
      - destination-rules
      - fault-injection
    security:
      - mutual-tls
      - authorization-policies
```

---

## 八、附录

### 8.1 服务端口规划

| 服务名 | 端口 | 健康检查路径 | 备注 |
|--------|------|--------------|------|
| hr-gateway | 8080 | /actuator/health | API网关 |
| hr-org-service | 8081 | /api/health | 组织权限 |
| hr-core-service | 8082 | /api/health | Core HR |
| hr-recruit-service | 8083 | /api/health | 招聘入职 |
| hr-attend-service | 8084 | /api/health | 考勤假勤 |
| hr-payroll-service | 8085 | /api/health | 薪酬薪资 |
| hr-perf-service | 8086 | /api/health | 绩效管理 |
| hr-ticket-service | 8087 | /api/health | 工单知识库 |
| hr-report-service | 8088 | /api/health | 报表分析 |
| hr-ai-service | 8089 | /api/health | AI能力 |
| hr-rag-service | 8090 | /api/health | RAG检索 |

### 8.2 数据库实例规划

| 数据库 | 用途 | 实例数 | 读写分离 |
|--------|------|--------|----------|
| mysql-org | 组织权限数据 | 1主 | 待扩展 |
| mysql-core | Core HR数据 | 1主 | 待扩展 |
| mysql-recruit | 招聘入职数据 | 1主 | 待扩展 |
| mysql-attend | 考勤数据 | 1主 | 待扩展 |
| mysql-payroll | 薪酬数据 | 1主 | 待扩展 |
| mysql-perf | 绩效数据 | 1主 | 待扩展 |
| mysql-ticket | 工单数据 | 1主 | 待扩展 |
| mysql-report | 报表数据 | 1主 | 待扩展 |
| mysql-ai | AI数据 | 1主 | 待扩展 |
| mysql-rag | RAG数据 | 1主 | 待扩展 |
| nacos-config | 配置存储 | 1主 | - |

### 8.3 技术栈版本

| 组件 | 版本 | 备注 |
|------|------|------|
| Spring Boot | 3.2.2 | - |
| Spring Cloud | 2023.0.0 | - |
| Spring Cloud Alibaba | 2023.0.1.0 | - |
| Spring AI Alibaba | 1.1.0.0-RC2 | agent-framework 基础依赖 |
| MyBatis Plus | 3.5.5 | - |
| JWT | - | 认证与多租户 |
| MySQL | 8.0 | - |
| Redis | 7.x | - |
| Kafka | 3.6 | - |
| Milvus | 2.5.4 | - |
| Nacos | 2.3.2 | - |
| Docker | 24.x | - |
| Kubernetes | 1.28+ | - |

---

> **文档维护**: 本文档随项目演进持续更新
>
> **最后更新**: 2026-02-02
